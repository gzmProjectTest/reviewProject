<template>
    <div style="height:100%;" id="addVoucher" @click="handleAddVoucher">
      <CardLayout :aside="false" :headerHeight="'100px'" :isComeBack="isComeBack">
        <template slot="header">
          <span v-if="isEditVoucher">编辑凭证录入</span>
          <span v-else>凭证录入</span>
        </template>
        <div class="addVoucher" slot="body">
          <div class="addVoucher-header" v-if="!isEditVoucher">
            <div class="addVoucher-header-right">
              <el-button size="small" @click="print">打印</el-button>
              <el-button v-if="isClick" size="small" @click="visibleManage = true">调用凭证模板</el-button>
              <el-button v-if="isClick" size="small" @click="dialogVisible = true">保存为凭证模板</el-button>
              <!-- <el-button v-if="(voucherInfo && voucherInfo.relationCard && voucherInfo.relationCard.length > 0) || !showAddTask" size="small" @click="showAddTask = true">添加任务核算项</el-button> -->
              <el-button
                v-if="isCommonTask && (voucherInfo && voucherInfo.relationCard && voucherInfo.relationCard.length === 0) || voucherInfo.relationCard === undefined"
                size="small"
                @click="handleShowTask">
                添加任务核算项
              </el-button>
              <i class="iconfont icon-prev-arrow" style="font-size: 22px;margin: 0 10px" :class="{ isdisabledPre: isdisabledPre }" @click="pre"></i>
              <i class="iconfont icon-xiayiye1" style="font-size: 22px;margin-right: 10px" :class="{ isdisabledNext: isdisabledNext }" @click="next"></i>
            </div>
          </div>
          <div v-else-if="isCommonTask && (voucherInfo && voucherInfo.relationCard && voucherInfo.relationCard.length === 0) || voucherInfo.relationCard === undefined" class="addVoucher-header" >
            <div class="addVoucher-header-right">
              <el-button v-if="isClick" size="small" @click="handleShowTask">添加任务核算项</el-button>
            </div>
          </div>
          <div class="addVoucher-content">
            <div class="addVoucher-content-top" style="margin-bottom: 10px">
              <div v-if="isEditVoucher">
                <div class="addVoucher-bookkeeping-voucher">{{title}}</div>
                <div v-if="!isClick" style="color: red;margin-left: 10px">亲，该凭证是系统生成的，不能修改</div>
              </div>
              <div v-else class="addVoucher-bookkeeping-voucher">记账凭证</div>
              <div class="addVoucher-bookkeeping-voucher-title-content">
                <div style="width:450px;display:flex;">
                                  <span>
                                      <span><span style="color:red;"> * </span>凭证字：</span>
                                      <el-select class="readonlySelect_special" placeholder="请选择" size="small" style="width: 100px" v-model="voucherInfo.voucherWord" :disabled="!isClick">
                                          <el-option v-for="item in voucherNumberList" :key="item.id" :label="item.name" :value="item.id"> </el-option>
                                      </el-select>
                                      <input v-model="voucherInfo.number" type="text" style="width: 50px;text-align: center;height:32px;margin-left:10px;" onkeyup="value=value.replace(/[^\d]/g,'')" :readOnly="!isClick" /> 号
                                  </span>
                  <span>
                                      <label><span style="color:red;margin-left:20px;">*</span>日期：</label>
                                      <el-date-picker
                      :readonly="!isClick"
                      class="readonlySelect_special"
                      style="width: 133px;"
                      v-model="voucherInfo.bookkeepingTime"
                      :picker-options="pickeroptions"
                      value-format="yyyy-MM-dd"
                      size="small"
                      type="date"
                      placeholder="选择日期"
                    >
                                      </el-date-picker>
                                  </span>
                </div>
                <span>{{bookkeepingTimePeriod}}</span>
                <div style="width:450px;display: flex;justify-content: flex-end;position:relative;">
                                  <span style="height: 32px;line-height: 32px">
                                      <label>凭证编号：</label>
                                      <input
                      v-model="voucherInfo.code"
                      type="text"
                      style="width: 150px;text-align: center"
                      onkeyup="value=value.replace(/[^\d]/g,'')"
                      disabled
                      placeholder="提交后自动生成" />
                                  </span>
                  <span v-if="voucherInfo.approveStatus === 'YSH'">
                                      <i class="iconfont icon-yishenhe yishenhe"></i>
                                  </span>
                  <span class="addVoucher-content-top-enclosure" style="display:flex;">
                                      <span>附件数：
                                          <span v-if="voucherInfo && voucherInfo.attacheds && voucherInfo.attacheds.length > 0" class="addVoucher-content-top-enclosure-Number">{{ voucherInfo.attacheds.length}}</span>
                                          <span v-else class="addVoucher-content-top-enclosure-Number">0</span>
                                      </span>
                                      <i class="iconfont icon-fujian" style="cursor:pointer;" @click="handleUpload"></i>
                                  </span>
                </div>
              </div>
            </div>
            <div style="display:flex;position: relative" @click.stop="handleSubjectPopover">
              <div style="display:flex;width:100%;overflow:auto;border-right:1px solid #BBBBBE;">
                              <table style="width:61px;position:absolute;z-index:10;">
                                  <thead>
                                      <tr>
                                          <th style="width:61px;background-color:#F6FAFE;">
                                              <span style="height:25px;line-height:25px;">&nbsp;</span>
                                          </th>
                                  </tr>
                                  </thead>
                                  <tbody>
                                      <tr
                                          v-for="(item, index) in contentList"
                                          :key="index"
                                          @click="mouseenter(item)"
                                          @mouseenter="showOperate(index, item)"
                                          @mouseleave="hideOperate(index)">
                                          <td :style="handleTdStyle(index)" class="icon" style="width:61px;display:table-cell;vertical-align:middle;text-align: center;position:relative;">
                                                  <span>
                                                      <span v-show="indexFlag === index" class="addVoucher-content-table-icon addVoucher-content-table-icon-add" @click="addVoucherItem(index)">+</span>
                                                      <span v-show="indexFlag === index" class="addVoucher-content-table-icon addVoucher-content-table-icon-reduce" @click="deleteVoucherItem(index)">-</span>
                                                  </span>
                                              <span v-show="indexFlag !== index">{{ index + 1 }}</span>
                                          </td>
                                      </tr>
                                      <tr style="font-size: 16px;">
                                          <td style="background:#FFF7D9;text-align:center;">合计</td>
                                      </tr>
                                  </tbody>
                              </table>
                <table style="min-width:2000px;margin-left: 64px;">
                  <thead>
                  <tr>
                    <th
                      v-for="(item, index) in titleList"
                      :key="index"
                      style="background-color:#F6FAFE;"
                      :class="{
                                                  quantity: item.key === 'amount',
                                                  currency: item.key === 'currency',
                                                  abstract: item.key === 'abstract',
                                                  subject: item.key === 'subject'
                                              }"
                    >
                      <span v-if="!item.label" style="height:25px;line-height:25px;">{{ item.value }}</span>
                      <strong v-if="item.label" class="voucher-direction">{{ item.value }}</strong>
                      <div v-if="item.label" class="voucher-money" style="background-color:#F6FAFE;">
                        <span v-for="(value, index01) in item.label" :key="index01" :class="{ last: value === '分' }">{{ value }}</span>
                      </div>
                      <div v-if="item.shareLabel" class="voucher-currency" style="height:25px;border-top: 1px solid #BBBBBE;line-height: 22px;">
                        <div
                          v-for="(currencValue, currencIndex) in item.shareLabel"
                          :style="handleCurrency(currencIndex)"
                          style="display:inline-block;height:25px;border:none;"
                          :key="currencIndex">
                          {{ currencValue }}
                        </div>
                      </div>
                    </th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr v-for="(item, index) in contentList" :key="index" @click="mouseenter(item)" @mouseenter="showOperate(index, item)" @mouseleave="hideOperate(index)">
                    <!-- 摘要 -->
                    <td class="abstract" style="position: relative;" :style="handleTdStyle(index)">
                      <div @mouseenter="handleAbstractName(true)" @mouseleave="handleAbstractName(false)">
                        <!--<input type="text"-->
                        <!--class="initInput"-->
                        <!--ref='summaryIndex'-->
                        <!--v-model="item.summary"-->
                        <!--@blur="summaryBlur(item)"-->
                        <!--@focus="summaryFocus($event,item,index)"-->
                        <!--@keyup.enter="$event.target.blur"-->
                        <!--/>-->
                        <div style="height:53px;">
                          <!-- <textarea
                                                          rows="1"
                                                          cols="30"
                                                          class="initInput"
                                                          ref='summaryIndex'
                                                          v-model="item.summary"
                                                          @blur="summaryBlur(item)"
                                                          @focus="summaryFocus($event,item,index)"
                                                          @keyup.enter="$event.target.blur"
                                                          @change="handleTextarea($event,item,index)"
                                                          style="resize:none"
                                                          :disabled="!isClick"
                                                      >
                                                      </textarea>
                                                      <ul  ref="abstractSelect resetBorder" class="summaryStyle" v-if="item.showSummary && abstractListCopy && abstractListCopy.length !==0">
                                                          <li v-for="val in abstractListCopy" :key="val.rowId" @click="chooseSummary(item,val)">{{val.summaryContent}}</li>
                                                      </ul> -->
                          <!-- -->
                          <el-select
                            v-if="isClick"
                            class="resetBorder"
                            v-model="item.summary"
                            filterable
                            :class="handleAbstractStyle(index)"
                            remote
                            ref="abstractSelect"
                            allow-create
                            default-first-option
                            placeholder=""
                            @visible-change="v => abstractVisibleChange(v, 'abstractSelect', index)"
                            @focus="summaryFocus($event,item,index)"
                            @keyup.enter="$event.target.blur"
                            @change="changeSummary(item)">
                            <el-option
                              v-for="item in abstractList"
                              :key="item.rowId"
                              :label="item.summaryContent"
                              :value="item.rowId">
                            </el-option>
                          </el-select>
                          <div v-else style="line-height:50px;padding-left:10px;">
                            {{item.summary}}
                          </div>
                        </div>
                        <span v-show="indexFlag === index && showAbstractName" @click.stop="handleAbstractCom(index)" style="color:#989E9D;position:absolute;right:15px;top:21px;cursor:pointer;">摘要</span>
                      </div>
                    </td>
                    <!-- 科目 -->
                    <td class="subject" :style="handleTdStyle(index)">
                      <div class="content-value" @mouseenter="handleSubject(true)" @mouseleave="handleSubject(false)">
                        <el-select
                          :disabled="!isClick"
                          v-if="item.showSubject"
                          ref="select1"
                          class="resetBorder readonlySelect_special"
                          :class="handleSubjectStyle(index)"
                          id="add-voucher-subjcet"
                          style="width:100%;"
                          v-model="item.subjectCode"
                                                  :remote-method="handleSubjectRemoteMethod"
                          filterable
                          remote
                          default-first-option
                                                  @click.native="handleClickSubject"
                          @change="changeSubject"
                          @visible-change="v => visibleChange(v, 'select1', index)"
                          @keydown.enter.native.13="changeSubject(item.subjectCode)"
                        >
                          <el-option
                            v-for="val in subjectList"
                            :key="val.id"
                            :label="`${val.subjectCode}` + ' ' + `${val.subjectNameFull ? val.subjectNameFull : val.subjectName}`"
                            :value="val.subjectCode"
                          >
                            <!-- <span style="display: inline-block;width: 50%;">{{ val.subjectCode }}</span> -->
                            <!-- <span>{{ val.subjectNameFull }}</span> -->
                          </el-option>
                        </el-select>
                        <el-popover
                          placement="bottom"
                          trigger="manual"
                          v-model="item.showAccountDetail">
                          <div v-if="item.showAccountDetail" id="add-voucher-popover-content">
                            <div  v-show="ruleForm.showCustomer" class="add-voucher-popover-content-show">
                              <div class="add-voucher-popover-content-show-label">
                                <span>*</span>客户
                              </div>
                              <el-input
                                class="add-voucher-popover-content-show-input"
                                v-model="ruleForm.customer"
                                size="small">
                                <i class="iconfont icon-gengduo" slot="suffix" @click.stop="customerVisible = true"></i>
                              </el-input>
                            </div>
                            <div v-show="ruleForm.showSupplier" class="add-voucher-popover-content-show">
                              <div class="add-voucher-popover-content-show-label">
                                <span>*</span>供应商
                              </div>
                              <el-input
                                class="add-voucher-popover-content-show-input"
                                v-model="ruleForm.supplier"
                                size="small">
                                <i class="iconfont icon-gengduo" slot="suffix" @click.stop="supplierVisible = true"></i>
                              </el-input>
                            </div>
                            <div v-show="ruleForm.showWarehouse" class="add-voucher-popover-content-show">
                              <div class="add-voucher-popover-content-show-label">
                                <span>*</span>仓库
                              </div>
                              <el-input
                                class="add-voucher-popover-content-show-input"
                                v-model="ruleForm.warehouse"
                                size="small">
                                <i class="iconfont icon-gengduo" slot="suffix" @click.stop="$refs.warehouseRef.show()"></i>
                              </el-input>
                            </div>
                            <div v-show="ruleForm.showMateriel" class="add-voucher-popover-content-show">
                              <div class="add-voucher-popover-content-show-label">
                                <span>*</span>物料
                              </div>
                              <el-input
                                class="add-voucher-popover-content-show-input"
                                v-model="ruleForm.materiel"
                                size="small">
                                <i class="iconfont icon-gengduo" slot="suffix" @click.stop="addVoucherGoodList"></i>
                              </el-input>
                            </div>
                            <div v-show="ruleForm.showDepartment" class="add-voucher-popover-content-show">
                              <div class="add-voucher-popover-content-show-label">
                                <span>*</span>部门
                              </div>
                              <el-input
                                class="add-voucher-popover-content-show-input"
                                v-model="ruleForm.department"
                                size="small">
                                <i class="iconfont icon-gengduo" slot="suffix" @click.stop="showPersonPicker = true"></i>
                              </el-input>
                            </div>
                            <div v-show="ruleForm.showStaffMember" class="add-voucher-popover-content-show">
                              <div class="add-voucher-popover-content-show-label">
                                <span>*</span>职员
                              </div>
                              <el-input
                                class="add-voucher-popover-content-show-input"
                                v-model="ruleForm.staffMember"
                                size="small">
                                <i class="iconfont icon-gengduo" slot="suffix" @click.stop="showDeptMemberVisible = true"></i>
                              </el-input>
                            </div>
                            <div style="text-align: right;">
                              <el-button size="small" @click.stop="handlerBusinessCancal(item)">取 消</el-button>
                              <el-button size="small" type="primary" @click.stop="handlerBusinessDetermine(item)">确 定</el-button>
                            </div>
                          </div>
                          <div
                            slot="reference"
                            v-show="!item.showSubject"
                            @click="clickSubject(item)"
                            :class="handleSubjectStyle(index)"
                            class="subject-static-style">
                            <el-popover
                              placement="top-start"
                              width="400"
                                                          :content="handleSubjectTopTip(item)"
                              trigger="hover">
                              <div slot="reference">
                                                              <!-- 这种调用方法存在问题，会让这个方法执行多次，待优化 {{ handleSubjectTopTip(item) }} -->
                                                              <div ref="subjectContent" :class="item.lineClamp2 ? 'subject-item-lineClamp2' : ''">{{ handleSubjectTopTip(item) }}</div>
                                <div
                                  v-show="isClick && item.subjectCode && voucherInfo.rowId"
                                  class="subject-static-style-balance">
                                  余额：{{ item.currencyBalance || '0.00' }}
                                </div>
                              </div>
                            </el-popover>
                          </div>
                        </el-popover>
                        <span v-show="indexFlag === index && showSubjectName" @click.stop="handleSubjectCom(index)" style="color:#989E9D;position:absolute;right:15px;top:21px;cursor:pointer;">科目</span>
                      </div>
                    </td>
                    <!-- 数量 -->
                    <td class="quantity" v-if="showCount" :style="handleTdStyle(index)">
                      <div v-if="item.showCount" class="quantity-content">
                        <div class="currency-content-currency-type">
                          <input
                            type="text"
                            maxlength="11"
                            @blur="countBlur"
                            v-model="item.count"
                            ref="quantityNumber"
                            @focus="showNumberIndex = true"
                            class="quantity-number-input"
                            :style="handleQuantityStyle(index)"
                            style="border:none;width:100%;text-align:center;"
                            :disabled="!isClick" />
                        </div>
                        <div v-if="measureList && measureList.length > 0" class="currency-content-exchange-rate quantity-content-company">
                          {{item.numberName ? item.numberName : handleSetUnitName(item)}}
                        </div>
                        <div class="currency-content-original-currency">
                          <input
                            type="text"
                            v-model="item.price"
                            @focus="showUnitPriceIndex = true"
                            @blur="priceBlur"
                            :style="handleUnitPriceStyle(index)"
                            class="quantity-price-input"
                            style="border:none;width:100%;text-align:center;"
                            :disabled="!isClick" />
                        </div>
                      </div>
                      <div v-else class="quantity-content">
                        <div class="currency-content-currency-type">&nbsp;</div>
                        <div class="currency-content-exchange-rate">&nbsp;</div>
                        <div class="currency-content-original-currency">&nbsp;</div>
                      </div>
                    </td>
                    <!-- 币别 -->
                    <td class="currency" v-if="showCurrency" :style="handleTdStyle(index)">
                      <div v-if="item.showCurrency" class="currency-content">
                        <!-- <div>
                                                      <select v-model="item.currencyCode" @change="changeCurrency($event)" :disabled="!isClick">
                                                          <option v-for="(val, index01) in currencyList" :key="index01" :value="val.code">{{ val.name }}</option>
                                                      </select>
                                                      <input type="text" style="margin-left: 10px" class="exchangeRate" v-model="item.rate" :disabled="item.fixedRate !== '1'"  @blur="rateBlur"/>
                                                      <input type="text" style="margin-left: 10px" class="exchangeRate" v-model="item.rate" :disabled="rateDidabled(item)" @blur="rateBlur" />
                                                  </div>
                                                  <div>
                                                      <label>原币：</label>
                                                      onkeyup="value=value.replace(/[^\d|.]/g,'')"
                                                      <input type="text" v-model="item.originalAccount" @blur="originalAccountBlur" class="quantity-price-input" />
                                                  </div> -->
                        <div class="currency-content-currency-type"  @mouseenter="showCurrencytIndex = true" @mouseleave="showCurrencytIndex = false">
                          <!-- <select
                                                          v-model="item.currencyCode"
                                                          filterable
                                                          class="set-select"
                                                          @change="changeCurrency($event)"
                                                          :disabled="!isClick">
                                                          <option
                                                              v-for="(val, index01) in currencyList"
                                                              :key="index01"
                                                              :value="val.code">
                                                              {{ val.name }}
                                                          </option>
                                                      </select> -->
                          <el-select
                            v-model="item.currencyCode"
                            filterable
                            class="set-select"
                            :class="handleCurrencytClass(index)"
                            @change="changeCurrency($event)"
                            :disabled="!isClick">
                            <el-option
                              v-for="(val) in currencyList"
                              :key="val.code"
                              :label="val.name"
                              :value="val.code">
                            </el-option>
                          </el-select>
                        </div>
                        <div class="currency-content-exchange-rate">
                          <input
                            v-model="item.rate"
                            type="text"
                            style="width:100%;border:none;text-align:center;"
                            :disabled="rateDidabled(item)"
                            @blur="rateBlur" />
                        </div>
                        <div class="currency-content-original-currency">
                          <input
                            type="text"
                            @focus="showOriginalCurrencyIndex = true"
                            :style="handleOriginCurrency(index)"
                            style="width:100%;border:none;text-align:center;"
                            v-model="item.originalAccount"
                            @blur="originalAccountBlur"
                            class="quantity-price-input" />
                        </div>
                      </div>
                      <div v-else class="currency-content">
                        <div class="currency-content-currency-type">&nbsp;</div>
                        <div class="currency-content-exchange-rate">&nbsp;</div>
                        <div class="currency-content-original-currency">&nbsp;</div>
                      </div>
                    </td>
                    <!-- 借方 -->
                    <td :style="handleTdStyle(index)" tabindex="0" @focus="showInput('debit', item, index)">
                      <div
                        v-if="!item.showDebit"
                        class="borrow-money"
                        tabindex="1"
                        :class="{ plusOrMinus: item.isMinus }"
                        style="text-align: right;"
                        :style="handleTdStyle(index)"
                        @click="showInput('debit', item, index)">
                        <div class="content-value">
                          {{ item.debitAmount }}
                        </div>
                      </div>
                      <input
                        v-else
                        class="inputMoney"
                        ref="input1"
                        type="text"
                        @blur="onblur('debit')"
                        :style="handleBorrowStyle(index)"
                        @keyup.enter="$event.target.blur"
                        @focus="onFocus('debit')"
                        v-model="item.debitAmount"
                        autofocus
                      />
                    </td>
                    <!-- 贷方 -->
                    <td :style="handleTdStyle(index)" tabindex="0" @focus="showInput('credit', item, index)">
                      <div
                        v-if="!item.showCredit"
                        class="credit-money"
                        :class="{ plusOrMinus: item.isMinus }"
                        style="text-align: right;"
                        :style="handleTdStyle(index)"
                        @click="showInput('credit', item, index)">
                        <div class="content-value">
                          {{ item.creditAmount }}
                        </div>
                      </div>
                      <input
                        v-else
                        class="inputMoney"
                        ref="input2"
                        type="text"
                        :style="handleLoanStyle(index)"
                        @blur="onblur('credit')"
                        @keyup.enter="$event.target.blur"
                        @focus="onFocus('credit')"
                        v-model="item.creditAmount"
                        autofocus
                      />
                    </td>
                  </tr>
                  <tr style="font-size: 16px;">
                    <!-- <td class="operate"></td> -->
                    <td :colspan="colspan" style="background:#FFF7D9;padding-left:10px;">{{ capitalSum }}</td>
                    <td class="quantity" v-if="showCount" style="background:#FFF7D9;"></td>
                    <td class="currency" v-if="showCurrency" style="background:#FFF7D9;"></td>
                    <td class="borrow-money" style="text-align: right;background-color:#FFF7D9;" :class="{ isDebitMinus: voucherInfo.isDebitMinus }">
                      <div class="content-value">
                        {{ debitAccount }}
                      </div>
                    </td>
                    <td class="borrow-money" style="text-align: right;background-color:#FFF7D9;" :class="{ isLenderMinus: voucherInfo.isLenderMinus }">
                      <div class="content-value">
                        {{ lenderAccount }}
                      </div>
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <!-- 任务核算项 -->
            <!-- <table class="relation-card-table">
                          <tbody>
                              <tr
                                  v-for="(item, index) in voucherInfo.relationCard"
                                  :key="index"
                                  @mouseenter="showTaskOperate(index)"
                                  @mouseleave="hideTaskOperate(index)">
                                      <td class="relation-card" :style="index === taskIndex ? 'background:#F5F7FA;' : ''">
                                          <div class="relation-card-icon">
                                              <div class="icon-add" v-show="taskIndex === index" @click="addTask(index)">+</div>
                                              <div class="icon-minus icon-add" v-show="taskIndex === index" @click="minusTask(index)">-</div>
                                          </div>
                                          <span v-show="taskIndex !== index">{{ index + 1 }}</span>
                                      </td>
                                      <td style="width: calc(100% - 80px)" :style="index === taskIndex ? 'background:#F5F7FA;' : ''">
                                          <span class="dot" style="display:inline-block;width: 30%"  @click="showTask(item)" :style="{color: item.title ? '#000' :'#C0C4CC'}">
                                          <span style="color: #000">任务核算项：</span>
                                          {{ item.title ? item.title : '请选择任务核算项' }}
                                          </span>
                                          <span>
                                          <span> 金额：</span>
                                          <el-input style="width: 297px" class="resetBorder" v-model="item.account" :readonly="!isClick" placeholder="请输入金额"></el-input>
                                          </span>
                                      </td>
                                  </tr>
                          </tbody>
                      </table> -->
            <!-- 审核模版 -->
            <div class="addVoucher-content-bottom" style="margin-top: 14px">
              <el-row>
                <el-col :span="6">制单人：{{ voucherInfo.cardUserName }}</el-col>
                <!--<el-col :span="4">出纳人：</el-col>-->
                <el-col :span="6">审核人：{{ voucherInfo.examineName }}</el-col>
                <!-- <el-col :span="4">
                                  <el-select class="readonlySelect_special" :disabled="!isClick" v-model="temp" placeholder="模板" size="mini" style="width: 100px" @visible-change="tempVisibleChange">
                                      <el-option label="存为模板" :value="0"> </el-option>
                                      <el-option label="使用模板" :value="1"> </el-option>
                                  </el-select>
                              </el-col> -->
                <el-col :span="12" v-if="isEditVoucher" style="display: flex;justify-content: flex-end;">
                  <el-button size="small" type="primary" v-if="isClick" @click="pickData">保存</el-button>
                </el-col>
                <el-col :span="12" style="display: flex;justify-content: flex-end;" v-else>
                  <!-- <el-button v-if="voucherInfo.approveStatus === 'DSH' && execute" size="small" @click="operationApprove('WT')">转交</el-button>
                                  <el-button v-if="voucherInfo.approveStatus === 'DSH' && execute" type="primary" size="small" @click="operationApprove('YSH')">审核</el-button>
                                  <el-button v-if="voucherInfo.approveStatus === 'DSH' && execute" type="primary" size="small" @click="operationApprove('FQ')">驳回</el-button>
                                  <el-button size="small" type="primary" v-if="isClick" @click="save('SH')">提交审核</el-button> -->
                  <el-button size="small" type="primary" v-if="isClick" @click="save('ZC')">保存</el-button>
                  <el-button size="small" type="primary" v-if="isClick" @click="save('BC')">保存并新增</el-button>
                  <el-button v-if="voucherInfo.approveStatus === 'YSH'" size="small" type="primary" @click="hasDeApprove = true">反审核</el-button>
                  <Workflow
                    v-if="isWorkflow"
                    ref="workflow"
                    :eventAuto="false"
                    :workflowId="workflowId"
                    :autoLaunch="true"
                    :autoExecute="true"
                    :launchParams="initParams"
                    :executeParams="executeParams"
                    @haveToDoFn="haveToDoFn"
                    @wtSuccess="wtSuccess"
                    @launchFn="tiJiaoShenHe"
                    @executeFn="jieDianShenHe"
                    @launchSuccess="successWorkflow"
                    @executeSuccess="successExecute">
                  </Workflow>
                </el-col>
              </el-row>
            </div>
          </div>
          <div style="height:10px; background:#eff2f5;"></div>
          <!-- 任务核算项 -->
          <div style="background:#fff;" v-if="showAddTask || (voucherInfo && voucherInfo.relationCard && voucherInfo.relationCard.length > 0)">
            <common-task
              v-model="voucherInfo.relationCard"
              :valueItem="relationCardItem"
              :read-only="!isClick"
              :showSelect="false"
              :showOperation="false"
              :showTotalMoney="false"
              :showAddData="false"
              :store-module="'financepc'"/>
          </div>
          <!-- 任务 -->
          <Select-task
            :visible="financialRenwuShow"
            @close="financialRenwuShow=false"
            @confirm="getDialogData"
          >
          </Select-task>
          <!--是否保存金额（存为模板）-->
          <el-dialog title="新增模板" :visible.sync="dialogVisible" width="20%" :before-close="handleClose">
            <el-form>
              <el-form-item label="模板名称">
                <el-input v-model="voucherInfo.name" style="width: 150px" size="mini"></el-input>
              </el-form-item>
              <el-form-item label="保存金额">
                <el-checkbox v-model="form.save"></el-checkbox>
              </el-form-item>
            </el-form>
            <span slot="footer" class="dialog-footer">
                          <el-button @click="dialogVisible = false">取 消</el-button>
                          <el-button type="primary" @click="saveTmep">确 定</el-button>
                      </span>
          </el-dialog>
          <!--模板管理-->
          <template-manage
            :subjectList="subjectList"
            :systemSettingData="systemSettingData"
            :currencyList="currencyList"
            :measureList="measureList"
            :visibleManage="visibleManage"
            :abstractList="abstractList"
            @cancel="visibleManage = false"
            @confirm="confirm"
          >
          </template-manage>
          <!--打印模板-->
          <print-template-voucher
            :abstractList="abstractList"
            :printData="voucherInfo"
            :list="contentList"
            :showCount="showCount"
            :showCurrency="showCurrency"
            :voucherNumberList="voucherNumberList"
          >
          </print-template-voucher>
          <!-- 科目组件 -->
          <subject-picker
            :showPicker="showSubjectCom"
            @picked="onPicked"
            @abort="showSubjectCom=false">
          </subject-picker>
          <creat-subject
            ref="creatSubjectRef"
            @successInit="seletByCode(radio1)">
          </creat-subject>
          <!-- 反审核组件 -->
          <de-approve
            :reverseFlag.sync="hasDeApprove"
            @cancel="hasDeApprove = false"
            @pick="reverseAudit">
          </de-approve>
          <!-- 摘要组件 -->
          <abstract-com
            :showAbstract="showAbstractCom"
            :selectAbstract="selectAbstract"
            @pick="handleAbstract"
            @handleDeleteAbstractCom="handleDeleteAbstractCom"
            @canlal="showAbstractCom = false">
          </abstract-com>
          <!-- 只选部门不选人 -->
          <select-department
            id="add-voucher-select-department"
            :multiple="true"
            :visible.sync="showPersonPicker"
            :dept="initialSelectedDept"
            @cancel="showPersonPicker = false"
            @onConfirm="handlerDepartment">
          </select-department>
          <el-dialog title="附件资料" :visible.sync="dialoguploadVisible" width="960px">
            <common-upload :annexList="voucherInfo.attacheds" :readOnly="!isClick" @AddannexList="AddannexList" @deleteAnnex="deleteAnnex"> </common-upload>
          </el-dialog>
          <!--供应商组件-->
          <supplier
            :supplierVisible="supplierVisible"
            :supplierName='searchData.supplierName'
            @cancel="supplierVisible=false"
            @confirm="confirmSupplier">
          </supplier>
          <!--客户组件-->
          <customer
            :customerVisible="customerVisible"
            @cancel="customerVisible=false"
            @confirm="confirmCustomer">
          </customer>
          <!--选择物品-->
          <common-goodsList
            ref="goodsListRef"
            @confirm="handlerMateriel"
            :Single="true"
            :filterIds="filterIds">
          </common-goodsList>
          <!-- ---选人组件 -->
          <deptMember
            :multiple="multiple"
            :visible.sync="showDeptMemberVisible"
            :showDept="showDept"
            :members="formData"
            @cancel="showDeptMemberVisible = false"
            @onConfirm="handleDeptMemberonConfirm">
          </deptMember>
          <!-- 选择仓库 -->
          <warehouse-manage
            ref="warehouseRef"
            @close="validateWarehouse"
            @confirm="handlerWarehouse">
          </warehouse-manage>
        </div>
      </CardLayout>
    </div>
  </template>
  
  <script>
      import templateManage from '../template/templateManage'
      import printTemplateVoucher from '../template/printTemplateVoucher'
      import { deepCopy, isEmtVal } from '@/utils/fn'
      import { parseDateStr } from '@/utils/date'
      import merge from '@/utils/mergeHttp'
      import SelectTask from '@/components/business/task/pc/SelectTask.vue'
      import { mapGetters } from 'vuex'
      import {
          addData,
          handlerData,
          dealData,
          dealTempData,
          initVoucher,
          voucherNumCheck,
          digitUppercase,
          priceConversion,
          priceFill,
          handlerTmepData,
          printTemplateByDomId
      } from '@/pages/Finance/Pc/Services/utils/commonJs'
      import { getMyDateStage } from '@/pages/Finance/Pc/Services/utils/commonJs.js'
      import SubjectPicker from '@/components/business/subjectpicker/SubjectPickerPc.vue'
      import creatSubject from '@/pages/Finance/App/Pages/children/creatSubject.vue'
      import Workflow from '@/components/business/approval/pc/launch-execute'
      import deApprove from '@/pages/Finance/Pc/Pages/loanReimbursement/components/reverseAudit.vue'
      import abstractCom from '../template/abstract-com'
      import {Z_IsEmpty20 as zIsempty20} from '@/utils/fn'
      import selectDepartment from '@/components/business/member-select-pc/selectDepartment'
      import commonUpload from '@/pages/GoodsLibrary/Pc/Pages/goodsLibrary/inventoryControl/otherInOrOutOrderList/commonComponent/uploadFile.vue'
      import supplier from '@/components/business/supplierPopup/supplier'
      import customer from '@/components/business/customerPopup/customer'
      import commonGoodsList from '@/components/business/commonGoodsListPC/common-goodsList.vue'
      import deptMember from '@/components/business/member-select-pc/deptMember'
      import warehouseManage from '@/components/business/warehouseManagePC/warehouse-manage.vue'
      import CardLayout from '@/components/business/card-layout/index'
      import CommonTask from '@/components/business/task/pc/taskAccounting/index.vue'
  
      export default {
          name: 'add-voucher',
          components: {
              templateManage,
              printTemplateVoucher,
              SelectTask,
              SubjectPicker,
              creatSubject,
              Workflow,
              deApprove,
              abstractCom,
              selectDepartment,
              commonUpload,
              supplier,
              customer,
              commonGoodsList,
              deptMember,
              warehouseManage,
              CardLayout,
              CommonTask
          },
          inject:['reload'],
          data() {
              return {
                  divWidth: 0,
                  bookkeepingTimePeriod: '',
                  initialSelectedDept: [],
                  filterIds: [],
                  loading:false,
                  SHID:'',
                  isWorkflow: true,
                  workflowId: '',
                  colspan: 2,
                  colspan4: 4,
                  voucherNumberList: [], // 凭证字
                  voucherNumberItem: [],
                  subjectList: [], // 科目设置
                  copySubjectList: [], // 科目设置
                  subjectAllList: [], //所有科目设置
                  subject: [],
                  abstractList: [], // 摘要设置
                  abstract: [],
                  currencyList: [], // 币别数据
                  measureList: [], // 计量组单位数据
                  subjectSingle: {}, // 科目数据
                  systemSettingData: {}, // 系统参数配置
                  titleList: [
                      // {
                      // 	key: 'operate',
                      // 	value: ''
                      // },
                      // {
                      // 	key: 'number',
                      // 	value: ''
                      // },
                      {
                          key: 'abstract',
                          value: '摘要'
                      },
                      {
                          key: 'subject',
                          value: '会计科目'
                      },
                      {
                          key: 'borrower',
                          value: '借方',
                          label: ['亿', '千', '百', '十', '万', '千', '百', '十', '元', '角', '分']
                      },
                      {
                          key: 'lender',
                          value: '贷方',
                          label: ['亿', '千', '百', '十', '万', '千', '百', '十', '元', '角', '分']
                      }
                  ], // table  头部
                  titleList1: [
                      {
                          key: 'number',
                          value: ''
                      }
                  ], // table  头部
                  pickeroptions:{},
                  voucherInfo: {
                      attacheds: [],
                      name: '', // 模板名称
                      companyId: '',
                      debitCount: 0,
                      lenderCount: 0,
                      isDebitMinus: false,
                      isLenderMinus: false,
                      code: '',
                      cardUrl:'',
                      cardUserName: '',
                      approveStatus: 'WTJ',
                      voucherType: 'PZ',
                      voucherWord: '', // 凭证字
                      bookkeepingTime: '', // 时间
                      debitAccount: '0.00', // 借方金额
                      lenderAccount: '0.00', // 贷方金额
                      relationCard: [],
                      number: '' // 字号
                  },
                  relationCardItem: { //任务核算项
                      title: '',
                      account: '',
                      status: '',
                      responsibleCardUrl: '',
                      participantsCardUrl: ''
                  },
                  contentList: [], // table  内容
                  item: null,
                  type: '',
                  indexFlag: -1,
                  taskIndex:'',
                  taskItem:{},
                  showCount: false, // 判断是否先数量 币别
                  showCurrency: false,
                  visible: false,
                  financialRenwuShow: false, // 任务数据
                  isdisabledPre: true,
                  isdisabledNext: false,
                  temp: '', // 模板
                  dialogVisible: false,
                  form: {
                      save: ''
                  },
                  visibleManage: false, //使用模板
                  showLaunchWorkflow:false, // 审批流标识
                  initParams:{
                      wfType: 'MODULE_TYPE_ZYK',
                      mType:'PZ',
                      url:'/zingbiz/financial/voucher/startWorkflow',
                      useDefaultJump:false,
                      bookkeepingTimePeriod: ''
                  }, // 跳转审批流
                  execute:false, // 是否为可执行节点
                  showSubjectCom: false,
                  subjectIndexFlag: '',
                  executeParams: {},
                  hasDeApprove: false,
                  showAbstractCom: false,
                  selectAbstract: {},
                  showSubjectName: false,
                  showAbstractName: false,
                  oldSummaryIndex: 0, // 储存摘要旧的下标
                  accountingProjectArray: [],
                  rules: {
                      customer: [
                          { required: true, message: '请选择客户名称', trigger: 'change' }
                      ],
                      supplier: [
                          { required: true, message: '请选择供应商名称', trigger: 'change' }
                      ],
                      warehouse: [
                          { required: true, message: '请选择仓库', trigger: 'change' }
                      ],
                      materiel: [
                          { required: true, message: '请选择物料', trigger: 'change' }
                      ],
                      department: [
                          { required: true, message: '请选择部门', trigger: 'change' }
                      ],
                      staffMember: [
                          { required: true, message: '请选择职员', trigger: 'change' }
                      ]
                  },
                  showPersonPicker: false, //部门
                  supplierVisible: false, // 供应商
                  customerVisible: false, // 客户
                  searchData: {
                      supplierMainName: ''
                  },
                  dialoguploadVisible: false,
                  showDeptMemberVisible: false, //职员 = 选人
                  multiple: true, // 选人组件需要参数
                  showDept: true, // 选人组件需要参数
                  formData: [], // 选人组件需要参数
                  nextFn: '', //判断当前页面是否有路由跳转
                  supplierListobj: {},
                  isComeBack: false,
                  isEditVoucher: false,
                  otherVoucher: false,
                  showNumberIndex: false, //数量聚焦
                  showUnitPriceIndex: false, //单价聚焦
                  showCurrencytIndex: false, //币别
                  showOriginalCurrencyIndex: false, //原币金额
                  showLoanIndex: false, //贷方聚焦
                  showBorrowIndex: false, //借方聚焦
                  showAddTask: false //显示任务核算项
              }
          },
          beforeRouteLeave (to, from, next) {
              if (from.name === 'addVoucher' && this.voucherInfo.approveStatus !== 'DSH' && this.voucherInfo.approveStatus !== 'YSH') {
                  next(false)
                  this.nextFn = ''
                  this.nextFn = next
                  this.handleLeaveTip()
                  return
              }
              next()
          },
          computed: {
              // 借方金额
              debitAccount() {
                  let sum = 0
                  if (
                      this.contentList.filter(val => {
                          return val.showDebit
                      }).length === 0
                  ) {
                      let debit = this.contentList.filter(val => {
                          return val.debitAmount
                      })
  
                      if (debit.length !== 0) {
                          debit.forEach(item => {
                              // if (item.isMinus) {
                              //   sum -= parseFloat(this.priceConversion(item.debitAmount))
                              // } else {
                              //   sum += parseFloat(this.priceConversion(item.debitAmount))
                              // }
                              sum += parseFloat(this.priceConversion(item.debitAmount, item))
                          })
                      }
                  }
                  if (sum < 0) {
                      sum = Number(sum.toString().substring(1))
                  }
  
                  if (
                      this.contentList.filter(val => {
                          return val.debitAmount !== ''
                      }).length !== 0
                      && sum === 0
                  ) {
                      return '000'
                  }
                  if (sum === 0) {
                      return ''
                  }
                  return priceFill(sum)
              },
              // 贷方金额
              lenderAccount() {
                  let sum = 0
  
                  if (
                      this.contentList.filter(val => {
                          return val.showCredit
                      }).length === 0
                  ) {
                      let credit = this.contentList.filter(val => {
                          return val.creditAmount
                      })
  
                      if (credit.length !== 0) {
                          credit.forEach(item => {
                              // if (item.isMinus) {
                              //   sum -= parseFloat(this.priceConversion(item.creditAmount))
                              // } else {
                              //   sum += parseFloat(this.priceConversion(item.creditAmount))
                              // }
                              sum += parseFloat(this.priceConversion(item.creditAmount, item))
                          })
                      }
                  }
                  if (sum < 0) {
                      sum = Number(sum.toString().substring(1))
                  }
                  if (
                      this.contentList.filter(val => {
                          return val.creditAmount !== ''
                      }).length !== 0
                      && sum === 0
                  ) {
                      return '000'
                  }
                  if (sum === 0) {
                      return ''
                  }
                  return priceFill(sum)
              },
              // 判断是否为已审核或者未审核数据
              isClick() {
                  if (this.readOnly) {
                      return false
                  }
                  if ((this.voucherInfo.approveStatus === 'DSH' || this.voucherInfo.approveStatus === 'YSH')
                      || ((this.voucherInfo && this.defaultServer && this.voucherInfo.cardUrl && this.defaultServer.cardUrl && (this.voucherInfo.cardUrl !== this.defaultServer.cardUrl)) && !this.zingPerm('financialManageAdminPower'))
                  ) {
                      return false
                  }
                  return true
              },
              ...mapGetters(['defaultServer']),
              // 大小写
              capitalSum() {
                  if (this.lenderAccount === this.debitAccount && this.lenderAccount !== '' && this.lenderAccount !== 0) {
                      let cap = priceConversion(this.lenderAccount)
  
                      if (this.voucherInfo.isLenderMinus) {
                          return '负' + digitUppercase(cap)
                      }
                      return digitUppercase(cap)
                  }
                  return ''
              },
              // 摘要搜索
              abstractListCopy() {
                  let arr = []
  
                  if (this.item) {
                      if (this.item.summary === '') {
                          arr = this.abstractList
                      } else {
                          arr = this.abstractList.filter(val => {
                              return val.summaryContent.indexOf(this.item.summary) !== -1
                          })
                      }
                  }
                  return arr
              },
              isCommonTask() {
                  if (this.systemSettingData.isVoucherNeedRelationCard === 'false') {
                      return false
                  }
                  return true
              }
          },
          watch: {
              item: {
                  handler(newVal, oldVal) {
                      if (this.type === 'debit' && this.item.showDebit) {
                          this.$nextTick(function() {
                              this.$refs.input1[0].focus()
                          })
                      } else if (this.type === 'credit' && this.item.showCredit) {
                          this.$nextTick(function() {
                              this.$refs.input2[0].focus()
                          })
                      }
                      if (this.item.showSubject) {
                          this.$nextTick(function() {
                              this.$refs.select1[0].focus()
                          })
                      }
                  },
                  deep: true
              },
              lenderAccount: {
                  handler(val) {
                      let sum = 0
  
                      if (
                          this.contentList.filter(ele => {
                              return ele.showCredit
                          }).length === 0
                      ) {
                          let credit = this.contentList.filter(ele => {
                              return ele.creditAmount
                          })
  
                          if (credit.length !== 0) {
                              credit.forEach(item => {
                                  sum += parseFloat(this.priceConversion(item.creditAmount, item))
                              })
                          }
                      }
                      this.voucherInfo.isLenderMinus = false
                      if (sum < 0) {
                          this.voucherInfo.isLenderMinus = true
                      }
                      this.voucherInfo.lenderAccount = val
                  },
                  deep: true
              },
              debitAccount: {
                  handler(val) {
                      let sum = 0
  
                      if (
                          this.contentList.filter(ele => {
                              return ele.showDebit
                          }).length === 0
                      ) {
                          let debit = this.contentList.filter(ele => {
                              return ele.debitAmount
                          })
  
                          if (debit.length !== 0) {
                              debit.forEach(item => {
                                  sum += parseFloat(this.priceConversion(item.debitAmount, item))
                              })
                          }
                      }
                      this.voucherInfo.isDebitMinus = false
                      if (sum < 0) {
                          this.voucherInfo.isDebitMinus = true
                      }
                      this.voucherInfo.debitAccount = val
                  },
                  deep: true
              },
              'voucherInfo.bookkeepingTime': {
                  handler(val) {
                      this.bookkeepingTimePeriod = getMyDateStage(val)
                  }
              }
          },
          created() {
              this.subjectSelect()
              this.selectAccountingProject()
              const { voucherFullData, readOnly, isEditVoucher } = this.$route.params
              if (isEditVoucher) {
                  this.voucherFullData = voucherFullData
                  this.isEditVoucher = isEditVoucher
                  console.log('voucherFullData', voucherFullData)
                  console.log('isEditVoucher', isEditVoucher)
                  // 智能凭证页面点击编辑
                  // if (status === 'YSC') {
                  // 	readOnly === true
                  // }
                  this.readOnly = readOnly
                  this.init()
                  this.isComeBack = true
                  return
              }
              this.voucherInfo.companyId = this.$route.query.companyId
              this.initParams.companyId = this.$route.query.companyId;
              if (!this.$route.query.rowId) {
                  this.isComeBack = true
                  initVoucher(this)
              }else {
                  this.voucherInfoById(this.$route.query.rowId)
                  this.isComeBack = true
                  this.isdisabledNext = true
                  this.isdisabledPre = true
              }
              this.systemSetting().then(res => {
                  this.systemSettingData = res
                  console.log(this.systemSettingData, '1189--->')
                  if (res === null || JSON.stringify(res) === '{}' || res == 'null') {
                      this.$router.push({
                          path:'/finance/initParams',
                          query:{
                              companyId:this.$route.query.companyId
                          }
                      })
                      // this.$confirm('未设置会计期间，是否前往设置?', '提示', {
                      //   confirmButtonText: '确定',
                      //   cancelButtonText: '取消',
                      //   type: 'warning'
                      // }).then(() => {
                      //   this.$router.push({
                      //     path:'/finance/initParams',
                      //     query:{
                      //       companyId:this.$route.query.companyId
                      //     }
                      //   })
                      // })
                  } else {
                      // 判断当前月是否在当前会计期间
                      let time = parseDateStr(new Date()).split('-')[0] + '-' + parseDateStr(new Date()).split('-')[1]
                      this.pickeroptions.disabledDate = (T) => {
                          return T.getTime() < new Date(new Date(this.systemSettingData.currentAccountingPeriod).setHours(0, 0, 0, 0)).getTime()
                      }
                      if (res.currentAccountingPeriod && time !== res.currentAccountingPeriod) {
                          this.voucherInfo.bookkeepingTime = res.currentAccountingPeriod.split('-')[0] + '-' + res.currentAccountingPeriod.split('-')[1] + '-' + new Date(res.currentAccountingPeriod.split('-')[0],res.currentAccountingPeriod.split('-')[1],0).getDate()
                      } else {
                          this.voucherInfo.bookkeepingTime = parseDateStr(new Date())
                      }
                  }
                  this.voucherSetting().then(res1 => {
                      this.voucherNumberList = res1
                      if (this.voucherNumberList.length !== 0) {
                          if (this.voucherNumberList.filter(val => {
                              return val.isDefault === 'true'
                          }).length !== 0 ) {
                              this.voucherInfo.voucherWord = this.voucherNumberList.filter(val => {
                                  return val.isDefault === 'true'
                              })[0].id
                          }
                          // else {
                          //   this.voucherInfo.voucherWord = this.voucherNumberList[0].id
                          // }
                      }
                      this.currency().then(res2 => {
                          this.currencyList = res2
                          this.abstractSelect().then(res3 => {
                              this.abstractList = res3.filter(val => {
                                  return val.state === 'true'
                              })
                              this.searchMeasureUnit().then(res4 => {
                                  this.measureList = res4
                                  if (!this.$route.query.rowId) {
                                      this.loadVoucherInit()
                                  } else {
                                      this.voucherInfoById(this.$route.query.rowId)
                                      this.isdisabledNext = true
                                      this.isdisabledPre = true
                                  }
                              })
                          })
                      })
                  })
              })
          },
          methods: {
              handleUpload() {
                  if (!this.isClick) {
                      return
                  }
                  // if (!this.voucherInfo.attacheds) {
                  // 	this.voucherInfo.attacheds = []
                  // }
                  this.dialoguploadVisible = true
              },
              init() {
                  if (this.otherVoucher) {
                      this.title = '其他凭证'
                  } else {
                      this.title = '记账凭证'
                  }
                  this.showCount = false
                  this.showCurrency = false
                  this.titleList = [
                      {
                          key: 'abstract',
                          value: '摘要'
                      },
                      {
                          key: 'subject',
                          value: '会计科目'
                      },
                      {
                          key: 'borrower',
                          value: '借方',
                          label: ['亿', '千', '百', '十', '万', '千', '百', '十', '元', '角', '分']
                      },
                      {
                          key: 'lender',
                          value: '贷方',
                          label: ['亿', '千', '百', '十', '万', '千', '百', '十', '元', '角', '分']
                      }
                  ]
                  this.voucherFullDataCopy = deepCopy(this.voucherFullData)
                  dealData(this.voucherFullDataCopy, this,true)
                  if (!this.voucherInfo.attacheds) {
                      this.$set(this.voucherInfo, 'attacheds', [])
                  }
                  if ((this.voucherInfo && this.voucherInfo.relationCard.length === 0) || this.voucherInfo.relationCard === undefined) {
                      this.$set(this.voucherInfo, 'relationCard', [])
                  }
                  this.systemSetting().then(res => {
                      this.systemSettingData = res
                      this.currency().then(res2 => {
                          this.currencyList = res2
                          this.searchMeasureUnit().then(res3 => {
                              this.measureList = res3
                              this.abstractSelect().then(res4 => {
                                  // 摘要的数据
                                  this.abstractList = res4.filter(val => {
                                      return val.state === 'true'
                                  })
                                  this.voucherSetting().then(res5 => {
                                      // console.log('凭证字号res5----->', res5)
                                      this.voucherNumberList = res5
                                      if (this.voucherNumberList.length !== 0) {
                                          if (this.voucherNumberList.filter(ele => { return ele.isDefault === 'true' }).length !== 0 ) {
                                              this.voucherInfo.voucherWord = this.voucherNumberList.filter(value => {
                                                  return value.isDefault === 'true'
                                              })[0].id
                                          }
                                      }
                                  })
                              })
                          })
                      })
                  })
              },
              getMyDateStage,
              zIsempty20,
              // 控制审批审核按钮的显示
              disabledBtn(obj){
                  if(obj.SH){
                      this.execute = true
                  } else {
                      this.execute = false
                  }
                  if (this.SHID) {
                      if (this.execute) {
                          this.$router.replace({
                              path: 'addVoucher',
                              query: {
                                  companyId: this.$route.query.companyId,
                                  rowId: this.SHID
                              }
                          })
                      } else {
                          this.$router.push({
                              path: 'voucherManage',
                              query: {
                                  companyId: this.$route.query.companyId
                              }
                          })
                      }
                  }
              },
              handleTextarea(event,item,index) {
                  console.log('--------------')
                  console.log(event,item,index)
              },
              // 摘要获取焦点
              summaryFocus(event,item,index) {
                  console.log(event, '---->')
                  this.handleHidePopover()
                  if (item.summary === '') { // 赋值
                      if (+index > +this.oldSummaryIndex) { // 当前聚焦位置不为 0
                          this.oldSummaryIndex = index
                          let firstIndex = -1 // 首次输入的位置
                          for (let i = 0; i < this.contentList.length; i ++) {
                              const ele = this.contentList[i]
                              if (ele.summary !== '' && ele.summary !== undefined) {
                                  firstIndex = i
                                  if (ele.summary !== '' && firstIndex >= 0) {
                                      if (this.contentList[firstIndex].summaryId === '') {
                                          item.summary = this.contentList[firstIndex].summary
                                      } else {
                                          item.summary = this.contentList[firstIndex].summary
                                          item.summaryId = this.contentList[firstIndex].summaryId
                                      }
                                  }
                                  break;
                              }
                          }
                      } else if (+this.oldSummaryIndex === +index) {
                          if (this.contentList[0].summary !== '') {
                              if (this.contentList[0].summaryId === '') {
                                  item.summary = this.contentList[0].summary
                              } else {
                                  item.summary = this.contentList[0].summary
                                  item.summaryId = this.contentList[0].summaryId
                              }
                          }
                      }
                  }
                  // this.$nextTick(() => { // 全选
                  // 	this.$refs.summaryIndex[index].select()
                  // })
                  this.contentList.forEach(val => {
                      val.showSummary = false
                  })
                  item.showSummary = true
              },
              //  摘要失去焦点
              summaryBlur(item) {
                  setTimeout(() => {
                      item.showSummary = false
                      if (item.summaryId) {
                          if ( this.abstractList.filter(val => {
                              return val.rowId === item.summaryId
                          })[0].length !==0) {
                              if (item.summary !== this.abstractList.filter(val => {
                                  return val.rowId === item.summaryId
                              })[0].summaryContent) {
                                  item.summaryId = ''
                              }
                          }
                      }
                      this.changeSummary(item)
                  },200)
              },
              // 选择摘要
              chooseSummary(item,val) {
                  item.summary = val.summaryContent
                  item.summaryId= val.rowId
              },
              // 请求合并
              requestMerge() {
                  merge
                      .get('/zingbiz/financial/systemSetting/select', {})
                      .get('/zingbiz/financial/voucherSetting/select', { pageNumber:1,pageSize:300 })
                      .get('/zingbiz/financial/currency/select', { isDisable: 'false' })
                      .post('/zingbiz/goodsStorehouse/dictionaryStoreRest/getDictionaryList', { type: 'unit' }) // 查询计量组单位
                  merge.then((a, b, c, d) => {
                      if (a.data.success) {
                          this.systemSettingData = a.data.data
                      } else {
                          this.$vux.toast.text(a.data.msg)
                      }
                      if (b.data.success) {
                          this.voucherNumberList = b.data.data
                          this.voucherInfo.voucherWord = this.voucherNumberList[0].id
                      } else {
                          this.$vux.toast.text(b.data.msg)
                      }
                      if (c.data.success) {
                          this.currencyList = c.data.data
                      } else {
                          this.$vux.toast.text(c.data.msg)
                      }
                      if (d.data.success) {
                          if (d.data.data && d.data.data.length > 0) {
                              this.measureList = d.data.data.filter( item => item.baseUnitStatus === 'true')
                          }
                      } else {
                          this.$message({ type: 'error', message: d.data.msg })
                      }
                      this.abstractSelect()
                      if (!this.$route.query.rowId) {
                          this.loadVoucherInit()
                      } else {
                          this.voucherInfoById(this.$route.query.rowId)
                      }
                  })
              },
              // 计量单位
              searchMeasureUnit() {
                  return new Promise((resolve, reject) => {
                      let url = '/zingbiz/goodsStorehouse/dictionaryStoreRest/getDictionaryList'
  
                      this.$http
                          .post(url, { type: 'unit' })
                          .then(res => {
                              if (res.data.success) {
                                  if (res.data.data && res.data.data.length > 0) {
                                      const resData = res.data.data.filter( item => item.baseUnitStatus === 'true')
                                      resolve(resData)
                                  }
                                  // this.measureList = res.data.data
                              } else {
                                  this.$message({ type: 'error', message: res.data.msg })
                              }
                          })
                          .catch(error => {
                              reject(error)
                          })
                  })
              },
              // 系统参数
              systemSetting() {
                  return new Promise((resolve, reject) => {
                      let url = '/zingbiz/financial/systemSetting/select'
  
                      this.$http.get(url, {}).then(res => {
                          if (res.data.success) {
                              resolve(res.data.data)
                          }
                      })
                  })
              },
              // 凭证字
              voucherSetting() {
                  return new Promise((resolve, reject) => {
                      let url = '/zingbiz/financial/voucherSetting/select'
                      this.$http
                          .get(url, {
                              params:{
                                  status: 'false',
                                  pageNumber:1,
                                  pageSize:300
                              }
                          })
                          .then(res => {
                              if (res.data.success) {
                                  resolve(res.data.data)
                                  // this.voucherNumberList = res.data.data
                                  // this.voucherInfo.voucherWord = this.voucherNumberList[0].id
                              } else {
                                  this.$message({ type: 'error', message: res.data.msg })
                              }
                          })
                          .catch(error => {
                              reject(error)
                          })
                  })
              },
              //币别
              currency() {
                  return new Promise((resolve, reject) => {
                      let url = '/zingbiz/financial/currency/select'
  
                      this.$http
                          .get(url, {
                              isDisable: 'false'
                          })
                          .then(res => {
                              if (res.data.success) {
                                  resolve(res.data.data)
                                  // this.currencyList = res.data.data
                              } else {
                                  this.$message({ type: 'error', message: res.data.msg })
                              }
                          })
                          .catch(error => {
                              reject(error)
                          })
                  })
              },
              // 查询信息
              voucherInfoById(rowId) {
                  let url = '/zingbiz/financial/voucher/selectVoucherInfoById'
                  this.$http
                      .get(url, {
                          params: {
                              rowId: rowId
                          }
                      })
                      .then(res => {
                          if (res.data.success) {
                              const resData = res.data.data
                              dealData(resData, this)
                              if (resData.voucherType !== 'PZ') {
                                  this.isWorkflow = false
                              } else if (resData.approveStatus === 'WTJ' || zIsempty20(resData.approveStatus) || zIsempty20(resData.workId)) {
                                  this.workflowId = ''
                              } else {
                                  this.workflowId = resData.workId
                              }
                          } else {
                              this.$vux.toast.text('加载失败，请重试')
                          }
                      })
                      .catch(error => {
                          console.log(error)
                      })
              },
              // 凭证初始化
              loadVoucherInit() {
                  let url = '/zingbiz/financial/voucher/getVoucherInit'
  
                  this.$http.get(url, {}).then(res => {
                      if (res.data.success) {
                          this.voucherInfo.code = res.data.data.code
                          this.voucherInfo.cardUrl = res.data.data.cardUrl
                          this.voucherInfo.cardUserName = res.data.data.cardUserName
                      } else {
                          this.$vux.toast.text('加载失败，请重试')
                      }
                  })
              },
              // 请求摘要配置
              abstractSelect() {
                  return new Promise((resolve, reject) => {
                      let url = '/zingbiz/financial/commonAbstracts/list'
  
                      this.$http
                          .get(url, {
                              params: {
                                  pageSize: 999,
                                  pageNumber: 1
                              }
                          })
                          .then(res => {
                              if (res.data.success) {
                                  resolve(res.data.data)
                                  // this.abstractList = res.data.data
                              } else {
                                  this.$vux.toast.text(res.data.msg)
                              }
                          })
                          .catch(error => {
                              reject(error)
                          })
                  })
              },
              // 请求科目数据
              subjectSelect() {
                  let url = '/zingbiz/financial/subject/selectByParams'
                  this.$http
                      .get(url, {
                          params: {
                              dataType: 'all',
                              isDisable:false
                          }
                      })
                      .then(res => {
                          if (res.data.success) {
                              this.subjectList = res.data.data.filter((item,index) => item.isDetail !== 'true' && +index <= 19)
                              this.copySubjectList = this.subjectList
                              this.subjectAllList = res.data.data.filter( item =>item.isDetail !== 'true')
                          } else {
                              this.$message({ type: 'error', message: res.data.msg })
                          }
                      })
                      .catch(error => {
                          console.log(error)
                      })
              },
              // 科目点击
              clickSubject(item) {
                  this.handleHidePopover()
                  if (!this.isClick) {
                      return
                  }
                  this.item = item
                  this.item.showSubject = true
              },
              print() {
                  this.$nextTick(() => {
                      printTemplateByDomId('printTemplateVoucher', true)
                  })
              },
              // 上一页
              pre() {
                  // if (this.isdisabledPre === false) {
                  //   return
                  // }
                  let url = '/zingbiz/financial/voucher/perVoucher'
  
                  this.$http
                      .get(url, {
                          params: {
                              bookkeepingTime: this.voucherInfo.bookkeepingTime,
                              number: +this.voucherInfo.number - 1
                          }
                      })
                      .then(res => {
                          if (res.data.success) {
                              if (res.data.data) {
                                  this.isdisabledNext = true
                                  if (res.data.data) {
                                      this.$router.push({
                                          path: 'addVoucher',
                                          query: {
                                              companyId: this.$route.query.companyId,
                                              rowId: res.data.data.rowId
                                          }
                                      })
                                      dealData(res.data.data, this)
                                  }
                              } else {
                                  this.isdisabledPre = false
                                  this.$message({ type: 'error', message: '无上一张凭证' })
                              }
                          } else {
                              this.$message({ type: 'error', message: res.data.msg })
                          }
                      })
              },
              // 下一页
              next() {
                  console.log('下一页')
                  if (!this.$route.query.rowId) {
                      this.$message({ type: 'error', message: '无下一张凭证' })
                      return
                  }
                  let url = '/zingbiz/financial/voucher/nextVoucher'
  
                  this.$http
                      .get(url, {
                          params: {
                              bookkeepingTime: this.voucherInfo.bookkeepingTime,
                              number: +this.voucherInfo.number + 1
                          }
                      })
                      .then(res => {
                          if (res.data.success) {
                              if (res.data.data) {
                                  this.isdisabledPre = true
                                  this.$router.replace({
                                      path: 'addVoucher',
                                      query: {
                                          companyId: this.$route.query.companyId,
                                          rowId: res.data.data.rowId
                                      }
                                  })
                                  dealData(res.data.data, this)
                              } else {
                                  this.isdisabledNext = false
                                  this.$message({ type: 'error', message: '无下一张凭证' })
                              }
                          } else {
                              this.$message({ type: 'error', message: res.data.msg })
                          }
                      })
              },
              // 选择摘要
              changeSummary(item) {
                  this.item = item
                  let arr = this.abstractList.filter(val => {
                      return val.rowId === this.item.summary
                  })
  
                  this.item.showCount = false
                  this.item.showCurrency = false
                  // this.item.price = ''
                  // this.item.count = ''
                  // this.item.currencyCode = ''
                  // this.item.currencyName = ''
                  // this.item.rate = ''
                  // this.item.convertWay = ''
                  // this.item.originalAccount = ''
                  this.item.fullData = ''
                  this.item.accountingProject = ''
                  // this.item.unitGroup = ''
                  // this.item.unit = ''
                  if (arr.length !== 0) {
                      this.item.subjectCode = ''
                      this.item.subjectName = ''
                      this.item.summary = arr[0].summaryContent
                      if (arr[0].subjectCode) {
                          this.item.subjectCode = arr[0].subjectCode
                          this.changeSubject(arr[0].subjectCode)
                      }
                  }
              },
              /**
               * 选择科目
               * @param {String} code 科目编码
               * @param {Array} subjectList 科目的集合
               * @param {Array} contentList 录入数据表格的集合
               */
              async changeSubject(code) {
                  const subjectFilterList = this.subjectAllList.filter(val => val.subjectCode === code)
                  if (subjectFilterList && subjectFilterList.length === 0) {
                      return
                  }
                  this.handleHidePopover()
                  this.item.accountingProject = ''
                  this.ruleForm = {
                      customer: '',
                      customerCode: '',
                      showCustomer: false,
                      supplier: '',
                      supplierCode: '',
                      supplierId: '',
                      showSupplier: false,
                      warehouse: '',
                      warehouseCode: '',
                      showWarehouse: false,
                      materiel: '',
                      materielCode: '',
                      showMateriel: false,
                      department: '',
                      showDepartment: false,
                      staffMember: '',
                      showStaffMember: false
                  }
                  // 判断科目数据是否有币别和项目核算项
                  if (
                      this.subjectAllList.filter(val => {
                          return val.subjectCode === code
                      })[0].isChild === 'true'
                  ) {
                      this.contentList.forEach(val => {
                          val.showSubject = false
                      })
                      this.item.subjectCode = ''
                      this.item.subjectName = ''
                      this.$message({ type: 'error', message: '存在子集科目，无法选择父集' })
                      return
                  }
                  let subjectArr = this.subjectAllList.filter(val => {
                      return val.subjectCode === code
                  })
                  if (subjectArr[0].currencyBalance) {
                      this.item.currencyBalance = subjectArr[0].currencyBalance
                  } else {
                      this.item.currencyBalance = '0.00'
                  }
                  console.log('subjectArr----', subjectArr[0])
                  console.log('数量------', subjectArr[0].amountAuxiliaryAccounting)
                  console.log('币别，核算---', subjectArr[0].foreignCurrencyAccounting)
                  console.log('currencyId----', this.systemSettingData.currencyId)
                  if (subjectArr[0].subjectNameFull) {
                      this.item.subjectName = subjectArr[0].subjectNameFull
                  } else {
                      this.item.subjectName = subjectArr[0].subjectName
                  }
                  // this.item.fullData = ''
                  // this.item.accountingProject = ''
                  // this.item.unitGroup = ''
                  // this.item.unit = ''
                  this.contentList.forEach(val => {
                      val.showSubject = false
                  })
                  // 弹出科目的 el-popover 组件
                  if (subjectArr[0].amountAuxiliaryAccounting === 'true' || subjectArr[0].businessAccounting === 'true') {
                      // this.visible = true
                      // this.subjectSingle = subjectArr[0]
                      console.log('1744----->>>>', zIsempty20(subjectArr[0].accountingProject))
                      if (subjectArr[0] && !zIsempty20(subjectArr[0].accountingProject)) {
  
                          let arr = []
                          const that = this
                          subjectArr[0].accountingProject.split(' ').forEach( (item,index) => {
                              arr.push(new Promise(function (resolve, reject) {
                                      that.handleAccountingProject(item, resolve)
                                  }
                              ))
                          })
                          Promise.all(arr).then((result)=>{
                              this.$set(this.item, 'showAccountDetail', true)
                          })
                      }
                  }
                  console.log('1851----------->', this.item)
                  this.handleAmountColumn(subjectArr)
                  this.handleCurrenColumn(subjectArr)
              },
              // 处理币别，如果相应的条件满足，则展示币别列
              handleCurrenColumn(subjectArr) {
                  // if (this.isEditVoucher && this.item && this.item.currencyCode) {
                  // 	return
                  // }
                  // 科目外币核算 为不核算或者本位币不显示 否则显示 (控制币别一栏)
                  if (subjectArr[0].isForeignCurrencyAccounting === 'true' && subjectArr[0].foreignCurrencyAccounting.length !== undefined && subjectArr[0].foreignCurrencyAccounting.length === 0
                      || subjectArr[0].foreignCurrencyAccounting !== null && subjectArr[0].foreignCurrencyAccounting.length > 0 && subjectArr[0].foreignCurrencyAccounting !== '不核算') {
                      // 暂时不做currencyId 币别栏的限制
                      // && subjectArr[0].foreignCurrencyAccounting !== this.systemSettingData.currencyId
                      this.showCurrency = true
                      this.item.showCurrency = true
                      if (this.titleList[this.titleList.length - 3].key !== 'currency') {
                          this.titleList.splice(-2, 0, {
                              key: 'currency',
                              value: '币别',
                              shareLabel: ['币别', '汇率', '原币']
                          })
                      }
                      // 给币别赋值
                      if (
                          this.currencyList.filter(val => {
                              return val.id === subjectArr[0].foreignCurrencyAccounting
                          }).length !== 0
                      ) {
                          this.item.currencyCode = this.currencyList.filter(val => {
                              return val.id === subjectArr[0].foreignCurrencyAccounting
                          })[0].code
                          this.changeCurrency()
                      }
                      return
                  }
                  if (this.contentList && this.contentList.length > 0) {
                      // 清空币别所有数据
                      this.item.showCurrency = false
                      if (!this.contentList.some(val => val.showCurrency) && this.titleList[this.titleList.length - 3].key === 'currency') {
                          this.showCurrency = false
                          this.item.currencyCode = ''
                          this.item.currencyName = ''
                          this.item.rate = ''
                          this.item.convertWay = ''
                          this.item.originalAccount = ''
                          this.titleList.splice(this.titleList.length - 3, 1)
                      }
                  }
              },
              // 处理数量，如果相应的条件满足，则展示数量列
              handleAmountColumn(subjectArr) {
                  // 其他凭证中，某条单据已经生成，并且传了单位，编辑凭证录入，选择的某个科目（并开启了计量单位），那么不替换。
                  // if (this.isEditVoucher && this.item && this.item.unit) {
                  // 	return
                  // }
                  if (subjectArr[0].amountAuxiliaryAccounting === 'true') {
                      // 科目数量辅助金额判断（控制数量一栏）
                      if (this.measureList && this.measureList.length > 0) {
                          const nameIndex = this.measureList.findIndex( item => item.rowId === subjectArr[0].measureUnitId)
                          if (nameIndex !== -1) {
                              this.item.numberName = this.measureList[nameIndex].val
                              this.item.unit = subjectArr[0].measureUnitId
                          }
                          this.showCount = true
                          this.item.showCount = true
                          if (this.titleList[2].key !== 'amount') {
                              this.titleList.splice(2, 0, {
                                  key: 'amount',
                                  value: '数量',
                                  shareLabel: ['数量', '单位', '单价']
                              })
                          }
                      }
                      return
                  }
                  if (this.contentList && this.contentList.length > 0) {
                      this.item.showCount = false
                      // 1.将数量价格清空 借贷方金额保存
                      // 2.如果先选择有计量单位的科目，之后在选取没有计量单位的科目，需要将数量列给隐藏，并删除这列的数据。
                      if (!this.contentList.some(val => val.showCount) && this.titleList[2].key === 'amount') {
                          this.showCount = false
                          this.item.price = ''
                          this.item.count = ''
                          this.item.unit = ''
                          this.titleList.splice(2, 1)
                      }
                  }
              },
              // 模板下拉框
              tempVisibleChange(flag) {
                  if (!flag) {
                      if (this.temp === 0) {
                          this.dialogVisible = true
                      } else if (this.temp === 1) {
                          // 使用模板
                          this.visibleManage = true
                      }
                  }
              },
              // 关闭存为模板弹窗
              handleClose() {
                  this.dialogVisible = false
              },
              // 存为模板
              saveTmep() {
                  if (!this.voucherInfo.name) {
                      this.$message({ type: 'error', message: '请输入模板名称' })
                      return
                  }
                  this.voucherInfo.voucherInfoItems = this.contentList
                  let param = deepCopy(this.voucherInfo)
  
                  let params = handlerTmepData(param, this.form.save, this,'add')
  
                  if (params) {
                      let url = '/zingbiz/financial/voucherInfoTmpRest/save'
  
                      this.$http
                          .post(url, params)
                          .then(res => {
                              if (res.data.success) {
                                  this.$message({ type: 'success', message: '保存成功' })
                              } else {
                                  this.$message({ type: 'success', message: '保存失败' })
                              }
                              this.dialogVisible = false
                          })
                          .catch(error => {
                              console.log(error)
                          })
                  }
              },
              // 使用模板
              confirm(data) {
                  console.log(data)
                  let params = deepCopy(data)
  
                  dealTempData(params, this)
              },
              handleClickSubject() {
                  this.subjectList = this.copySubjectList
              },
              handleSubjectRemoteMethod(query) {
                  this.subjectList = this.subjectAllList.filter(item => {
                      if (item.subjectCode.indexOf(query) !== -1 || item.subjectNameFull.indexOf(query) !== -1 || item.subjectName.indexOf(query) !== -1) {
                          return item
                      }
                  }).splice(0, 19)
              },
              /**
               * 科目下拉框隐藏事件
               * @param {Blooean} flag 是否显示select选择框
               * @param {String} refName 当前元素的ref名称
               * @param {String}} index 当前元素的下标
               */
              visibleChange(flag, refName, index) {
                  if (!flag) {
                      this.contentList.forEach(val => {
                          val.showSubject = false
                      })
                  }
                  if (flag) {
                      this.handleHidePopover()
                      this.$forceUpdate()
                      let that = this
                      const ref = that.$refs[refName];
                      if (ref[0].$refs === undefined) return
                      let popper = ref[0].$refs.popper;
                      if (popper.$el) popper = popper.$el;
                      if (!Array.from(popper.children).some(v => v.className === 'el-cascader-menu__list')) {
                          // select 编码 名称的样式
                          const divEle1 =document.createElement('div')
                          divEle1.style = 'display:flex;width:100%;height:37px;line-height:37px;border-bottom:1px solid rgba(187, 187, 187, 100);background:#F2F2F2;'
                          divEle1.innerHTML = ` <div style="width:50%;height:37px;padding-left:5px;">
                          编码
                      </div>
                      <div style="width:50%;height:37px;padding-left:5px;border-left:1px solid #BBBBBB">
                          名称
                      </div>`
                          // select 新增 显示更多样式
                          const divEle2 = document.createElement('div');
                          divEle2.style = 'display:flex;width:100%;height:37px;line-height:37px;border-top:1px solid rgba(187, 187, 187, 100);';
                          divEle2.innerHTML = `<div style="width:50%;height:37px;text-align:center;cursor:pointer;" id="subject-add">
                          <i class="iconfont icon-prev-arrow isdisabledPre" id="subject-add"></i>
                          新增
                      </div>
                      <div style="width:50%;height:37px;text-align:center;cursor:pointer;border-left:1px solid #BBBBBB" id="subject-more">
                          <i class="iconfont icon-prev-arrow isdisabledPre" id="subject-more"></i>
                          显示更多
                      </div>`
                          // const a = document.getElementsByClassName('el-scrollbar')[1].parentElement.insertBefore(p, document.getElementsByClassName('el-scrollbar')[1])
                          // console.log('popper11', a)
                          const currentSelectElementArr = document.getElementsByClassName('el-scrollbar')
                          // 获取到的是当前元素
                          const scrollbarEle = currentSelectElementArr[currentSelectElementArr.length - 1]
                          // 如果想要在当前元素之前插入新元素，需要获取当前元素的父元素
                          scrollbarEle.parentElement.insertBefore(divEle1, scrollbarEle)
                          popper.appendChild(divEle2);
                          divEle2.addEventListener('click',function(e){
                              //e.target 得到点击的那个对象
                              console.log(1499, e.target.id)
                              if (e.target.id === 'subject-add') {
                                  // that.$refs.creatSubjectRef.addSubject(type, row, 'KMSZ')
                              } else if (e.target.id === 'subject-more') {
                                  that.handleSubjectCom(index)
                              }
                          })
                      }
                  }
              },
              /**
               * 摘要下拉框隐藏事件
               * @param {Blooean} flag 是否显示select选择框
               * @param {String} refName 当前元素的ref名称
               * @param {String}} index 当前元素的下标
               */
              abstractVisibleChange(flag, refName, index) {
                  if (flag) {
                      let that = this
                      // ref 获取的是一个数组， 为表格中的每一行。所以需要取下标
                      const ref = that.$refs[refName];
                      if (ref[index].$refs === undefined) return
                      let popper = ref[index].$refs.popper;
                      if (popper.$el) popper = popper.$el;
                      if (!Array.from(popper.children).some(v => v.className === 'el-cascader-menu__list')) {
                          // select 新增 显示更多样式
                          const divEle2 = document.createElement('div');
                          divEle2.className = 'el-cascader-menu__list'
                          divEle2.style = 'display:flex;width:100%;height:38px;line-height:28px;border-top:1px solid rgba(187, 187, 187, 100);';
                          divEle2.innerHTML = `<div style="width:100%;height:37px;text-align:center;cursor:pointer;>
                          <i class="iconfont icon-prev-arrow isdisabledPre"></i>
                          显示更多
                      </div>`
                          popper.appendChild(divEle2);
                          divEle2.addEventListener('click',function(e){
                              //e.target 得到点击的那个对象
                              that.handleAbstractCom(index)
                          })
                      }
                  }
              },
              // 点击
              mouseenter(item) {
                  this.item = item
              },
              // 鼠标进入
              showOperate(index, item) {
                  if (!this.isClick) {
                      return
                  }
                  this.indexFlag = index
              },
              // 鼠标离开
              hideOperate(index) {
                  if (!this.isClick) {
                      return
                  }
                  this.indexFlag = -1
              },
              // 科目鼠标进入
              handleSubject(param) {
                  if (!this.isClick) {
                      return
                  }
                  this.showSubjectName = param
              },
              handleAbstractName(param) {
                  if (!this.isClick) {
                      return
                  }
                  this.showAbstractName = param
              },
              showTaskOperate(index) {
                  if (!this.isClick) {
                      return
                  }
                  this.taskIndex = index
              },
              hideTaskOperate(index) {
                  if (!this.isClick) {
                      return
                  }
                  this.taskIndex = ''
              },
              // 添加任务核算项明细
              addTask(index) {
                  if (!this.isClick) {
                      return
                  }
                  this.handleHidePopover()
                  if (index) {
                      this.voucherInfo.relationCard.splice(index,0,{
                          listId:'',
                          boardId:'',
                          account:'',
                          cardId: '',
                          title: ''
                      })
                  } else {
                      this.voucherInfo.relationCard.push(
                          {
                              listId:'',
                              boardId:'',
                              account:'',
                              cardId: '',
                              title: ''
                          }
                      )
                  }
  
              },
              minusTask(index) {
                  if (!this.isClick) {
                      return
                  }
                  this.handleHidePopover()
                  this.voucherInfo.relationCard.splice(index,1)
              },
              // 点击表格中任意事件，先隐藏科目中的 el-popover
              handleHidePopover() {
                  if (this.item) {
                      this.$set(this.item, 'showAccountDetail', false)
                  }
              },
              // 添加明细
              addVoucherItem(index) {
                  addData(index, this)
              },
              // 删除明细
              deleteVoucherItem(index) {
                  if (this.contentList.length === 2) {
                      this.$message({ type:'error', message:'科目数据不能少于2条'})
                      return
                  }
                  this.contentList.splice(index, 1)
              },
              // 价格转化
              priceConversion(price, item) {
                  let arr = deepCopy(price).split('')
  
                  arr.splice(-2, 0, '.')
                  if (item) {
                      if (item.isMinus) {
                          arr.unshift('-')
                      }
                  } else if (this.item.isMinus) {
                      arr.unshift('-')
                  }
                  return arr.join('')
              },
              // 价格保留小数点后两位
              priceFill(price) {
                  this.item.isMinus = false
                  let priceCopy = price
  
                  let reg = /^-/g
  
                  if (reg.test(priceCopy)) {
                      // 负数
                      this.item.isMinus = true
                      priceCopy = priceCopy.toString().substring(1)
                  }
                  if (/\./g.test(priceCopy)) {
                      // 是否有小数点
                      return Number(priceCopy)
                          .toFixed(2)
                          .toString()
                          .replace(/\./g, '')
                  }
                  return priceCopy + '00'
              },
              // 数量失去焦点
              countBlur() {
                  this.showNumberIndex = false
                  // 数量 * 价格 = 原币金额
                  if (this.item.showCurrency === false) {
                      // 币别为不核算或者本位币 不用考虑原币金额
                      if (this.item.count) {
                          if (this.item.price) {
                              this.computeCurrency()
                          } else {
                              if (this.item.debitAmount) {
                                  this.item.price = this.priceConversion(this.item.debitAmount) / this.item.count
                              }
                              if (this.item.creditAmount) {
                                  this.item.price = this.priceConversion(this.item.creditAmount) / this.item.count
                              }
                          }
                      } else {
                          if (this.item.price && this.item.creditAmount) {
                              this.item.count = this.priceConversion(this.item.creditAmount) / this.item.price
                          }
                          if (this.item.price && this.item.debitAmount) {
                              this.item.count = this.priceConversion(this.item.debitAmount) / this.item.price
                          }
                      }
                  } else if (this.item.showCurrency) {
                      // 需要考虑原币金额
                      if (this.item.count) {
                          if (this.item.price) {
                              this.item.originalAccount = this.item.count * this.item.price
                              this.computeCurrency()
                          } else if (this.item.originalAccount) {
                              this.item.price = this.item.originalAccount / this.item.count
                          }
                      } else if (this.item.price && this.item.originalAccount) {
                          this.item.count = this.item.originalAccount / this.item.price
                      }
                  }
              },
              // 价格失去焦点
              priceBlur() {
                  this.showUnitPriceIndex = false
                  if (this.item.showCurrency === false) {
                      if (this.item.price) {
                          if (this.item.count) {
                              this.computeCurrency()
                          } else {
                              if (this.item.debitAmount) {
                                  this.item.count = this.priceConversion(this.item.debitAmount) / this.item.price
                              }
                              if (this.item.creditAmount) {
                                  this.item.count = this.priceConversion(this.item.creditAmount) / this.item.price
                              }
                          }
                      } else {
                          if (this.item.count && this.item.creditAmount) {
                              this.item.price = this.priceConversion(this.item.creditAmount) / this.item.count
                          }
                          if (this.item.count && this.item.debitAmount) {
                              this.item.price = this.priceConversion(this.item.debitAmount) / this.item.count
                          }
                      }
                  } else if (this.item.price) {
                      if (this.item.count) {
                          this.item.originalAccount = this.item.count * this.item.price
                          this.computeCurrency()
                      } else if (this.item.originalAccount) {
                          this.item.count = this.item.originalAccount / this.item.price
                      }
                  } else if (this.item.count && this.item.originalAccount) {
                      this.item.price = this.item.originalAccount / this.item.count
                  }
              },
              // 原币金额变化
              originalAccountBlur(item) {
                  this.showOriginalCurrencyIndex = false
                  if (this.item.showCurrency && !this.item.showCount) {
                      // 有汇率 无数量
                      if (this.item.originalAccount) {
                          this.computeCurrency()
                      } else {
                          if (this.item.debitAmount) {
                              if (this.item.convertWay === 'multiplication') {
                                  this.item.originalAccount = this.priceConversion(this.item.debitAmount) / this.item.rate
                              } else if (this.item.convertWay === 'division') {
                                  // 原币金额 / 汇率 = 本币金额
                                  this.item.originalAccount = this.priceConversion(this.item.debitAmount) * this.item.rate
                              }
                          }
                          if (this.item.creditAmount) {
                              if (this.item.convertWay === 'multiplication') {
                                  this.item.originalAccount = this.priceConversion(this.item.creditAmount) / this.item.rate
                              } else if (this.item.convertWay === 'division') {
                                  // 原币金额 / 汇率 = 本币金额
                                  this.item.originalAccount = this.priceConversion(this.item.creditAmount) * this.item.rate
                              }
                          }
                      }
                  } else if (!this.item.showCurrency) {
                      // 有数量 有汇率
                      if (this.item.originalAccount) {
                          this.computeCurrency() // 修改借贷方金额
                          if (this.item.count) {
                              this.item.price = this.item.originalAccount / this.item.count
                          } else if (this.item.price) {
                              this.item.count = this.item.originalAccount / this.item.price
                          }
                      } else if (this.item.count && this.item.price) {
                          this.item.originalAccount = this.item.price * this.item.count
                          this.computeCurrency()
                      }
                  }
              },
              // 币别变化
              changeCurrency($event) {
                  let selectArr = this.currencyList.filter(val => {
                      return val.code === this.item.currencyCode
                  })
                  console.log('selectArr', selectArr);
                  console.log('selectArr', selectArr[0].name);
                  this.item.currencyName = selectArr[0].name
                  // this.item.rate = selectArr[0].rate // 汇率
                  this.$set(this.item, 'rate', selectArr[0].rate)
                  this.item.convertWay = selectArr[0].convertWay // 汇率计算方式
                  if (this.item.originalAccount) {
                      this.computeCurrency()
                  } else {
                      // 没有原币金额 判断是否需要根据本币金额倒推原币金额
                      if (this.item.debitAmount) {
                          if (this.item.convertWay === 'multiplication') {
                              this.item.originalAccount = this.priceConversion(this.item.debitAmount) / this.item.rate
                          } else if (this.item.convertWay === 'division') {
                              // 原币金额 / 汇率 = 本币金额
                              // this.item.originalAccount = this.priceFill(this.item.debitAmount * this.item.rate)
                              this.item.originalAccount = this.priceConversion(this.item.debitAmount) * this.item.rate
                          }
                          this.originalAccountBlur()
                      }
                      if (this.item.creditAmount) {
                          if (this.item.convertWay === 'multiplication') {
                              this.item.originalAccount = this.priceConversion(this.item.creditAmount) / this.item.rate
                          } else if (this.item.convertWay === 'division') {
                              // 原币金额 / 汇率 = 本币金额
                              // this.item.originalAccount = this.priceFill(this.item.creditAmount * this.item.rate)
                              this.item.originalAccount = this.priceConversion(this.item.creditAmount) * this.item.rate
                          }
                          this.originalAccountBlur()
                      }
                  }
              },
              // 币别是可以修改
              rateDidabled(item) {
                  let selectArr = this.currencyList.filter(val => {
                      return val.code === item.currencyCode
                  })
                  if (selectArr[0] && selectArr[0].fixedRate === '1') {
                      return false
                  }
                  return true
              },
              // 汇率失去焦点
              rateBlur() {
                  if (!this.item.rate) {
                      // 将汇率重置 (汇率不可为空)
                      let selectArr = this.currencyList.filter(val => {
                          return val.code === this.item.currencyCode
                      })
  
                      this.item.rate = selectArr[0].rate
                  } else if (this.item.rate) {
                      if (this.item.originalAccount) {
                          this.computeCurrency()
                      } else {
                          if (this.item.debitAmount) {
                              if (this.item.convertWay === 'multiplication') {
                                  this.item.originalAccount = this.priceConversion(this.item.debitAmount) / this.item.rate
                              } else if (this.item.convertWay === 'division') {
                                  // 原币金额 / 汇率 = 本币金额
                                  // this.item.originalAccount = this.priceFill(this.item.debitAmount * this.item.rate)
                                  this.item.originalAccount = this.priceConversion(this.item.debitAmount) * this.item.rate
                              }
                              this.originalAccountBlur()
                          }
                          if (this.item.creditAmount) {
                              if (this.item.convertWay === 'multiplication') {
                                  this.item.originalAccount = this.priceConversion(this.item.creditAmount) / this.item.rate
                              } else if (this.item.convertWay === 'division') {
                                  // 原币金额 / 汇率 = 本币金额
                                  // this.item.originalAccount = this.priceFill(this.item.creditAmount * this.item.rate)
                                  this.item.originalAccount = this.priceConversion(this.item.creditAmount) * this.item.rate
                              }
                              this.originalAccountBlur()
                          }
                      }
                  }
              },
              // 计算本位金额
              computeCurrency() {
                  if (this.item.showCurrency === false && this.item.showCount) {
                      // 根据数量单价计算借贷方金额
                      if (this.item.count && this.item.price) {
                          if (this.creditOrDebit(this.item.subjectCode)) {
                              this.item.debitAmount = this.priceFill(this.item.count * this.item.price)
                              this.item.creditAmount = ''
                          } else {
                              this.item.creditAmount = this.priceFill(this.item.count * this.item.price)
                              this.item.debitAmount = ''
                          }
                      }
                  } else if (this.item.showCurrency && !this.item.showCount) {
                      // 根据汇率计算借贷方金额
                      if (this.item.originalAccount && this.item.rate) {
                          // 存在原币金额
                          if (this.creditOrDebit(this.item.subjectCode)) {
                              if (this.item.convertWay === 'multiplication') {
                                  // 原币金额 * 汇率 = 本币金额
                                  this.item.debitAmount = this.priceFill(this.item.originalAccount * this.item.rate)
                              } else if (this.item.convertWay === 'division') {
                                  // 原币金额 / 汇率 = 本币金额
                                  this.item.debitAmount = this.priceFill(this.item.originalAccount / this.item.rate)
                              }
                              this.item.creditAmount = ''
                          } else {
                              if (this.item.convertWay === 'multiplication') {
                                  // 原币金额 * 汇率 = 本币金额
                                  this.item.creditAmount = this.priceFill(this.item.originalAccount * this.item.rate)
                              } else if (this.item.convertWay === 'division') {
                                  // 原币金额 / 汇率 = 本币金额
                                  this.item.creditAmount = this.priceFill(this.item.originalAccount / this.item.rate)
                              }
                              this.item.debitAmount = ''
                          }
                      }
                  } else if (this.item.originalAccount) {
                      // 判断借方金额 还是 贷方金额
                      if (this.creditOrDebit(this.item.subjectCode)) {
                          // 判断本币金额 计算方式
                          if (this.item.convertWay === 'multiplication') {
                              // 原币金额 * 汇率 = 本币金额
                              this.item.debitAmount = this.priceFill(this.item.originalAccount * this.item.rate)
                          } else if (this.item.convertWay === 'division') {
                              // 原币金额 / 汇率 = 本币金额
                              this.item.debitAmount = this.priceFill(this.item.originalAccount / this.item.rate)
                          }
                          this.item.creditAmount = ''
                      } else {
                          if (this.item.convertWay === 'multiplication') {
                              // 原币金额 * 汇率 = 本币金额
                              this.item.creditAmount = this.priceFill(this.item.originalAccount * this.item.rate)
                          } else if (this.item.convertWay === 'division') {
                              // 原币金额 / 汇率 = 本币金额
                              this.item.creditAmount = this.priceFill(this.item.originalAccount / this.item.rate)
                          }
                          this.item.debitAmount = ''
                      }
                  }
              },
              // 借方贷方输入金额
              showInput(type, item, index) {
                  if (!this.isClick) {
                      return
                  }
                  this.item = item
                  this.type = type
                  this.indexFlag = index
                  this.contentList.forEach(val => {
                      val.showDebit = false
                      val.showCredit = false
                  })
                  if (type === 'debit') {
                      item.showDebit = true
                      this.showBorrowIndex = true
                  } else if (type === 'credit') {
                      item.showCredit = true
                      this.showLoanIndex = true
                  }
              },
              // 按tab键，让贷方，借方聚焦
              handleLoanFocus(type, item, index) {
                  if (!this.isClick) {
                      return
                  }
                  this.item = item
                  this.type = type
                  this.indexFlag = index
                  this.contentList.forEach(val => {
                      val.showDebit = false
                      val.showCredit = false
                  })
                  if (type === 'debit') {
                      item.showDebit = true
                  } else if (type === 'credit') {
                      item.showCredit = true
                  }
              },
              // 获取焦点
              onFocus(type) {
                  console.log(this.item.isMinus)
                  if (type === 'credit') {
                      if (this.item.creditAmount) {
                          let arr = deepCopy(this.item.creditAmount).split('')
  
                          arr.splice(-2, 0, '.')
                          if (this.item.isMinus) {
                              arr.unshift('-')
                          }
                          this.item.creditAmount = Number(arr.join(''))
                      }
                  } else if (this.item.debitAmount) {
                      let arr = deepCopy(this.item.debitAmount).split('')
  
                      if (this.item.isMinus) {
                          arr.unshift('-')
                      }
                      arr.splice(-2, 0, '.')
                      this.item.debitAmount = Number(arr.join(''))
                  }
              },
              // 借方贷方失去焦点
              onblur(type) {
                  this.contentList.forEach(val => {
                      val.showDebit = false
                      val.showCredit = false
                  })
                  if (type === 'credit') {
                      this.showLoanIndex = false
                      if (this.item.creditAmount) {
                          this.item.debitAmount = ''
                          this.item.creditAmount = this.priceFill(this.item.creditAmount)
                      }
                  } else if (type === 'debit') {
                      this.showBorrowIndex = false
                      if (this.item.debitAmount) {
                          this.item.creditAmount = ''
                          this.item.debitAmount = this.priceFill(this.item.debitAmount)
                      }
                  }
                  if (!this.item.showCount && !this.item.showCurrency) {
                      // 无数量 无汇率
                      return
                  }
                  if (type === 'credit') {
                      // 贷方金额输入 (根据数量计算)
                      // 有数量 无汇率
                      if (this.item.showCurrency === false && this.item.creditAmount && this.item.showCount) {
                          if (this.item.count && this.item.price) {
                              // 反推价格
                              this.item.price = this.priceConversion(this.item.creditAmount) / this.item.count
                          } else if (this.item.count) {
                              this.item.price = this.priceConversion(this.item.creditAmount) / this.item.count
                          } else if (this.item.price) {
                              this.item.count = this.priceConversion(this.item.creditAmount) / this.item.price
                          }
                      } else if (this.item.showCurrency && this.item.creditAmount && !this.item.showCount) {
                          if (this.item.convertWay === 'multiplication') {
                              this.item.originalAccount = this.priceConversion(this.item.creditAmount) / this.item.rate
                          } else if (this.item.convertWay === 'division') {
                              // 原币金额 / 汇率 = 本币金额
                              this.item.originalAccount = this.priceConversion(this.item.creditAmount) * this.item.rate
                          }
                      } else if (this.item.showCurrency && this.item.creditAmount && this.item.showCount) {
                          // 有数量 有汇率
                          if (this.item.convertWay === 'multiplication') {
                              this.item.originalAccount = this.priceConversion(this.item.creditAmount) / this.item.rate
                          } else if (this.item.convertWay === 'division') {
                              // 原币金额 / 汇率 = 本币金额
                              this.item.originalAccount = this.priceConversion(this.item.creditAmount) * this.item.rate
                          }
                          if (this.item.originalAccount) {
                              if (this.item.count) {
                                  this.item.price = this.item.originalAccount / this.item.count
                              } else if (this.item.price) {
                                  this.item.count = this.item.originalAccount / this.item.price
                              }
                          } else if (this.item.count && this.item.price) {
                              this.item.count = this.item.originalAccount / this.item.price
                          }
                      }
                  } else if (this.item.showCurrency === false && this.item.debitAmount && this.item.showCount) {
                      if (this.item.count && this.item.price) {
                          this.item.price = this.priceConversion(this.item.debitAmount) / this.item.count
                      } else if (this.item.count) {
                          this.item.price = this.priceConversion(this.item.debitAmount) / this.item.count
                      } else if (this.item.price) {
                          this.item.count = this.priceConversion(this.item.debitAmount) / this.item.price
                      }
                  } else if (this.item.showCurrency && this.item.debitAmount && !this.item.showCount) {
                      if (this.item.convertWay === 'multiplication') {
                          this.item.originalAccount = this.priceConversion(this.item.debitAmount) / this.item.rate
                      } else if (this.item.convertWay === 'division') {
                          // 原币金额 / 汇率 = 本币金额
                          this.item.originalAccount = this.priceConversion(this.item.debitAmount) * this.item.rate
                      }
                  } else if (this.item.showCurrency && this.item.debitAmount && this.item.showCount) {
                      // 根据原币金额 汇率
                      if (this.item.convertWay === 'multiplication') {
                          this.item.originalAccount = this.priceConversion(this.item.debitAmount) / this.item.rate
                      } else if (this.item.convertWay === 'division') {
                          // 原币金额 / 汇率 = 本币金额
                          this.item.originalAccount = this.priceConversion(this.item.debitAmount) * this.item.rate
                      }
                      if (this.item.originalAccount) {
                          if (this.item.count) {
                              this.item.price = this.item.originalAccount / this.item.count
                          } else if (this.item.price) {
                              this.item.count = this.item.originalAccount / this.item.price
                          }
                      } else if (this.item.count && this.item.price) {
                          this.item.count = this.item.originalAccount / this.item.price
                      }
                  }
              },
              // 处理科目 项目核算及单位
              handleSubjectBusinessAccounting(data) {
                  let arr = []
  
                  data.forEach(val => {
                      if (val.measureGroup) {
                          this.item.unitGroup = val.id
                          this.item.fullData += '.' + val.name + '_'
                      } else if (val.measure) {
                          this.item.unit = val.id
                          this.item.fullData += val.name
                      }
                  })
                  data.forEach(item => {
                      if (!item.measureGroup && !item.measure) {
                          if (item.code) {
                              this.item.fullData += '.' + item.code + '_' + item.name
                          } else {
                              this.item.fullData += '.' + item.name
                          }
                          let str = item.parentId + '#' + item.id
  
                          arr.push(str)
                      }
                  })
                  console.log('2499--->', arr)
                  console.log('2499--->', arr.join(' '))
                  this.item.accountingProject = arr.join(' ')
              },
              // 判断本币金额还是原币金额
              creditOrDebit(code) {
                  let subjectArr = this.subjectAllList.filter(val => {
                      return val.subjectCode === code
                  })
  
                  if (subjectArr[0].category === '资产' || subjectArr[0].category === '成本' || subjectArr[0].category === '损益' || subjectArr[0].category === '共同' || subjectArr[0].category === '表外') {
                      // 借方金额
                      return true
                  }
                  return false
              },
              // 显示任务核算项
              showTask(item) {
                  if (!this.isClick) {
                      return
                  }
                  this.taskItem = item
                  this.financialRenwuShow = true
              },
              // 关闭任务弹窗
              goBackShow() {
                  this.financialRenwuShow = false
              },
              // 任务返回数据
              getDialogData(data) {
                  // 获得任务页面返回数据
                  if (typeof this.voucherInfo.relationCard === 'object' && this.voucherInfo.relationCard.length > 0) {
                      for (let i = 0; i < this.voucherInfo.relationCard.length; i++) {
                          if (this.voucherInfo.relationCard[i].cardId === data.cardId) {
                              this.$vux.toast.text('任务已存在，请重新选择')
                              return
                          }
                      }
                  }
  
                  this.taskItem.title =  data.tasks[0].title
                  this.taskItem.listId = data.tasks[0].listId
                  this.taskItem.boardId = data.tasks[0].boardId
                  this.taskItem.cardId = data.tasks[0].cardId
                  this.taskItem.account = ''
                  // 	this.voucherInfo.relationCard.push({
                  //   listId:data.listId,
                  //   boardId:data.boardId,
                  //   account:'',
                  //   cardId: data.cardId,
                  //   title: data.title
                  // })
                  this.financialRenwuShow = false
              },
              isNull(val) {
                  return typeof val === 'undefined' || val === null || val === ''
              },
              // 委托 审核 驳回
              operationApprove(type) {
                  if (type === 'WT') {
                      this.$refs.executeWorkflow.execute({},'WT')
                      return
                  }
                  let url = '/zingbiz/financial/voucher/approvalExecution'
                  let voucherType = 'plain'
                  if (this.$route.query.rowId) {
                      if (this.voucherInfo.voucherType === 'DBD') {
                          voucherType = 'allocation'
                      }
                  }
                  let initParams = {
                      postParams:{
                          voucherInfoId : this.$route.query.rowId,
                          voucherStatus:type,
                          voucherType:voucherType
                      },
                      url: url
                  }
                  if (type === 'YSH') {
                      this.$refs.executeWorkflow.execute(initParams,'SH')
                  } else if (type === 'FQ') {
                      this.$refs.executeWorkflow.execute(initParams,'BH')
                  }
              },
              // 审批提交成功
              successWorkflow(res) {
                  this.SHID = res.rowId
                  this.$router.replace({
                      path: 'addVoucher',
                      query: {
                          companyId: this.$route.query.companyId,
                          rowId: res.rowId
                      }
                  })
                  this.showLaunchWorkflow = false
                  this.voucherInfoById(res.rowId)
                  // this.showLaunchWorkflow = false
              },
              // 审核成功
              successExecute() {
                  this.voucherInfoById(this.$route.query.rowId)
              },
              // 是否未可执行节点
              disabledExecute(flag) {
                  this.execute = flag
                  if (this.SHID) {
                      if (this.execute) {
                          this.$router.replace({
                              path: 'addVoucher',
                              query: {
                                  companyId: this.$route.query.companyId,
                                  rowId: this.SHID
                              }
                          })
                      } else {
                          this.$router.push({
                              path: 'voucherManage',
                              query: {
                                  companyId: this.$route.query.companyId
                              }
                          })
                      }
                  }
              },
              //disabledBtn(disabled) {
              // if (this.showLaunchWorkflow) {
              //   this.showLaunchWorkflow = false
              //   if (disabled.SH) {
              //     this.$router.replace({
              //       path: 'addVoucher',
              //       query: {
              //         companyId: this.$route.query.companyId,
              //         rowId: this.SHID
              //       }
              //     })
              //   } else {
              //     this.$router.push({
              //       path: 'voucherManage',
              //       query: {
              //         companyId: this.$route.query.companyId
              //       }
              //     })
              //   }
              // }
              //},
              handleCommonTask(param) {
                  let relation = false
                  if(this.systemSettingData.isVoucherNeedRelationCard === 'true') {
                      if (param.relationCard.length === 0) {
                          this.$message({type :'error', message:'请添加任务核算项'})
                          return true
                      }
                      if (param.relationCard && param.relationCard.length > 0) {
                          for (let i = 0; i < param.relationCard.length; i ++) {
                              const val = param.relationCard[i]
                              if (isEmtVal(val.title)) {
                                  relation = true
                                  this.$message({type :'error', message:'请选择任务核算项名称'})
                                  break
                              }
                              if (isEmtVal(val.account)){
                                  relation = true
                                  this.$message({type :'error', message:'请输入任务核算项金额'})
                                  break
                              }
                          }
                      }
                  }
                  return relation
              },
              // 保存 验证
              tiJiaoShenHe(fn) {
                  this.voucherInfo.voucherInfoItems = this.contentList
                  let param = deepCopy(this.voucherInfo)
                  let code = []
                  let disabeldSubject = {}
                  // 判断是否在结账期内 在这个结账期内 是不可以暂存 审核 保存 反审核 删除
                  // this.systemSettingData.currentAccountingPeriod "yyyy-MM"
                  // this.voucherInfo.bookkeepingTime 'yyyy-MMM-dd'
                  if (Date.parse(this.voucherInfo.bookkeepingTime) < Date.parse(this.systemSettingData.currentAccountingPeriod + '-01')) {
                      this.$message({type :'error', message:'该期间已结账'})
                      return
                  }
                  if (this.handleCommonTask(param)) {
                      return
                  }
                  //判断引用科目是否被禁用
                  this.subjectAllList.forEach(val => {
                      code.push(val.subjectCode)
                  })
                  if (this.voucherInfo.voucherInfoItems && this.voucherInfo.voucherInfoItems.length > 0) {
                      for (const subject of this.voucherInfo.voucherInfoItems) {
                          if (subject.subjectCode && code.indexOf(subject.subjectCode) === -1) { // 找不到的就是已禁用的
                              disabeldSubject = subject
                              break
                          }
                      }
                  }
                  if (JSON.stringify(disabeldSubject) !== '{}') {
                      this.$message({ type:'error',message: disabeldSubject.subjectName + '已被禁用！'})
                      return
                  }
                  if (!this.isNull(this.voucherInfo.number)) {
                      this.loading = false
                      voucherNumCheck(this).then(res => {
                          if (res.success) {
                              if (res.data) {
                                  let params = handlerData(param, this)
                                  if (params) {
                                      if (this.systemSettingData.voucherActive === 'true') {
                                          this.initParams.postParams = params
                                          this.$refs.workflow[fn]()
                                          this.loading = false
                                      }
                                  } else {
                                      this.loading = false
                                  }
                              } else {
                                  this.loading = false
                                  this.$message({ type: 'error', message: '此凭证号已存在' })
                              }
                          } else {
                              this.loading = false
                          }
                      })
                      return
                  }
                  let params = handlerData(param, this)
                  // if (params && this.systemSettingData.voucherActive === 'true') {
                  if (params) {
                      this.initParams.postParams = params
                      this.$refs.workflow[fn]()
                  }
              },
              save(type) {
                  this.voucherInfo.voucherInfoItems = this.contentList
                  let param = deepCopy(this.voucherInfo)
                  let code = []
                  let disabeldSubject = {}
                  // 判断是否在结账期内 在这个结账期内 是不可以暂存 审核 保存 反审核 删除
                  // this.systemSettingData.currentAccountingPeriod "yyyy-MM"
                  // this.voucherInfo.bookkeepingTime 'yyyy-MMM-dd'
                  if (Date.parse(this.voucherInfo.bookkeepingTime) < Date.parse(this.systemSettingData.currentAccountingPeriod + '-01')) {
                      this.$message({type :'error', message:'该期间已结账'})
                      return
                  }
                  if (this.handleCommonTask(param)) {
                      return
                  }
                  //判断引用科目是否被禁用
                  this.subjectAllList.forEach(val => {
                      code.push(val.subjectCode) // 已启用状态
                  })
                  if (this.voucherInfo.voucherInfoItems && this.voucherInfo.voucherInfoItems.length > 0) {
                      for (const subject of this.voucherInfo.voucherInfoItems) {
                          if (subject.subjectCode && code.indexOf(subject.subjectCode) === -1) { // 找不到的就是已禁用的
                              disabeldSubject = subject
                              break
                          }
                      }
                  }
                  if (JSON.stringify(disabeldSubject) !== '{}') {
                      this.$message({ type:'error',message: disabeldSubject.subjectName + '已被禁用！'})
                      return
                  }
                  if (!this.isNull(this.voucherInfo.number)) {
                      this.loading = false
                      console.log('2840----->', this.loading)
                      voucherNumCheck(this).then(res => {
                          if (res.success) {
                              if (res.data) {
                                  let params = handlerData(param, this)
                                  if (params) {
                                      // if (this.systemSettingData.voucherActive === 'true' && type === 'SH') {
                                      // 	this.initParams.postParams = params
                                      // 	this.showLaunchWorkflow = true
                                      // 	this.loading = false
                                      // 	return
                                      // }
                                      let url = ''
                                      if (this.$route.query.rowId) {
                                          url = '/zingbiz/financial/voucher/updateVoucher'
                                      } else {
                                          url = '/zingbiz/financial/voucher/insertVoucherFinance'
                                      }
                                      this.$http
                                          .post(url, params)
                                          .then(reslut => {
                                              if (reslut.data.success) {
                                                  this.$message({ type: 'success', message: '保存成功' })
                                                  if (type === 'ZC') {
                                                      this.$router.push({
                                                          path: 'addVoucher',
                                                          query: {
                                                              companyId: this.$route.query.companyId,
                                                              rowId: reslut.data.data.rowId
                                                          }
                                                      })
                                                      this.voucherInfoById(this.$route.query.rowId)
                                                  } else if (type === 'BC') {
                                                      this.$router.push({
                                                          path: 'addVoucher',
                                                          query: {
                                                              companyId: this.$route.query.companyId
                                                          }
                                                      })
                                                      if (!this.$route.query.rowId) {
                                                          this.voucherInfo = {
                                                              attacheds: [],
                                                              name: '', // 模板名称
                                                              companyId: '',
                                                              debitCount: 0,
                                                              lenderCount: 0,
                                                              isDebitMinus: false,
                                                              isLenderMinus: false,
                                                              code: '',
                                                              cardUserName: '',
                                                              approveStatus: 'WTJ',
                                                              voucherType: 'PZ',
                                                              voucherWord: '', // 凭证字
                                                              bookkeepingTime: '', // 时间
                                                              debitAccount: '0.00', // 借方金额
                                                              lenderAccount: '0.00', // 贷方金额
                                                              relationCard: [],
                                                              number: '' // 字号
                                                          }
                                                          if (this.voucherNumberList.length !== 0) {
                                                              if (this.voucherNumberList.filter(val => {
                                                                  return val.isDefault === 'true'
                                                              }).length !== 0 ) {
                                                                  this.voucherInfo.voucherWord = this.voucherNumberList.filter(val => {
                                                                      return val.isDefault === 'true'
                                                                  })[0].id
                                                              } else {
                                                                  this.voucherInfo.voucherWord = this.voucherNumberList[0].id
                                                              }
                                                          }
                                                          this.loadVoucherInit()
                                                          initVoucher(this)
                                                          let time = parseDateStr(new Date()).split('-')[0] + '-' + parseDateStr(new Date()).split('-')[1]
                                                          this.pickeroptions.disabledDate = (T) => {
                                                              return T.getTime() < new Date(new Date(this.systemSettingData.currentAccountingPeriod).setHours(0, 0, 0, 0)).getTime()
                                                          }
                                                          if (time !== res.currentAccountingPeriod) {
                                                              this.voucherInfo.bookkeepingTime = this.systemSettingData.currentAccountingPeriod.split('-')[0] + '-' + this.systemSettingData.currentAccountingPeriod.split('-')[1] + '-' + new Date(this.systemSettingData.currentAccountingPeriod.split('-')[0],this.systemSettingData.currentAccountingPeriod.split('-')[1],0).getDate()
                                                          } else {
                                                              this.voucherInfo.bookkeepingTime = parseDateStr(new Date())
                                                          }
                                                          // this.voucherInfo.bookkeepingTime = parseDateStr(new Date())
                                                      } else {
                                                          this.voucherInfoById(this.$route.query.rowId)
                                                      }
                                                  }
                                                  // else if (type === 'SH') {
                                                  // 	this.$router.push({
                                                  // 		path: '/workflow/workflowMain',
                                                  // 		query: {
                                                  // 			pzRowId: reslut.data.data.rowId,
                                                  // 			voucherType: 'PZ',
                                                  // 			companyId: this.voucherInfo.companyId,
                                                  // 			wfType: 'MODULE_TYPE_ZYK'
                                                  // 		}
                                                  // 	})
                                                  // }
                                              } else {
                                                  this.$message({ type: 'success', message: '保存失败' })
                                              }
                                              this.loading = false
                                          })
                                          .catch(error => {
                                              console.log(error)
                                              this.loading = false
                                          })
                                  } else {
                                      this.loading = false
                                  }
                              } else {
                                  this.loading = false
                                  this.$message({ type: 'error', message: '此凭证号已存在' })
                              }
                          } else {
                              this.loading = false
                          }
                      })
                  } else {
                      this.loading = false
                      console.log('2959----->', this.loading)
                      let params = handlerData(param, this)
  
                      if (params) {
                          this.loading = false
                          if (this.systemSettingData.voucherActive === 'true' && type === 'SH') {
                              this.initParams.postParams = params
                              console.log(this.initParams)
                              this.showLaunchWorkflow = true
                              this.loading = false
                              return
                          }
                          let url = ''
                          if (this.$route.query.rowId) {
                              url = '/zingbiz/financial/voucher/updateVoucher'
                          } else {
                              url = '/zingbiz/financial/voucher/insertVoucherFinance'
                          }
                          this.$http
                              .post(url, params)
                              .then(res => {
                                  this.loading = false
                                  if (res.data.success) {
                                      this.$message({ type: 'success', message: '保存成功' })
                                      if (type === 'ZC') {
                                          this.$router.push({
                                              path: 'addVoucher',
                                              query: {
                                                  companyId: this.$route.query.companyId,
                                                  rowId: res.data.data.rowId
                                              }
                                          })
                                          this.voucherInfoById(this.$route.query.rowId)
                                      } else if (type === 'BC') {
                                          this.$router.push({
                                              path: 'addVoucher',
                                              query: {
                                                  companyId: this.$route.query.companyId
                                              }
                                          })
                                          if (!this.$route.query.rowId) {
                                              this.voucherInfo = {
                                                  attacheds: [],
                                                  name: '', // 模板名称
                                                  companyId: '',
                                                  debitCount: 0,
                                                  lenderCount: 0,
                                                  isDebitMinus: false,
                                                  isLenderMinus: false,
                                                  code: '',
                                                  cardUserName: '',
                                                  approveStatus: 'WTJ',
                                                  voucherType: 'PZ',
                                                  voucherWord: '', // 凭证字
                                                  bookkeepingTime: '', // 时间
                                                  debitAccount: '0.00', // 借方金额
                                                  lenderAccount: '0.00', // 贷方金额
                                                  relationCard: [],
                                                  number: '' // 字号
                                              }
                                              if (this.voucherNumberList.length !== 0) {
                                                  if (this.voucherNumberList.filter(val => {
                                                      return val.isDefault === 'true'
                                                  }).length !== 0 ) {
                                                      this.voucherInfo.voucherWord = this.voucherNumberList.filter(val => {
                                                          return val.isDefault === 'true'
                                                      })[0].id
                                                  } else {
                                                      this.voucherInfo.voucherWord = this.voucherNumberList[0].id
                                                  }
                                              }
                                              this.loadVoucherInit()
                                              initVoucher(this)
                                              let time = parseDateStr(new Date()).split('-')[0] + '-' + parseDateStr(new Date()).split('-')[1]
                                              this.pickeroptions.disabledDate = (T) => {
                                                  return T.getTime() < new Date(new Date(this.systemSettingData.currentAccountingPeriod).setHours(0, 0, 0, 0)).getTime()
                                              }
                                              if (time !== res.currentAccountingPeriod) {
                                                  this.voucherInfo.bookkeepingTime = this.systemSettingData.currentAccountingPeriod.split('-')[0] + '-' + this.systemSettingData.currentAccountingPeriod.split('-')[1] + '-' + new Date(this.systemSettingData.currentAccountingPeriod.split('-')[0],this.systemSettingData.currentAccountingPeriod.split('-')[1],0).getDate()
                                              } else {
                                                  this.voucherInfo.bookkeepingTime = parseDateStr(new Date())
                                              }
                                          } else {
                                              this.voucherInfoById(this.$route.query.rowId)
                                          }
                                      }
                                      // else if (type === 'SH') {
                                      // 	this.$router.push({
                                      // 		path: '/workflow/workflowMain',
                                      // 		query: {
                                      // 			pzRowId: res.data.data.rowId,
                                      // 			voucherType: 'PZ',
                                      // 			companyId: this.voucherInfo.companyId,
                                      // 			wfType: 'MODULE_TYPE_ZYK'
                                      // 		}
                                      // 	})
                                      // }
                                  } else {
                                      this.$message({ type: 'success', message: '保存失败' })
                                  }
                              })
                              .catch(error => {
                                  this.loading = false
                                  console.log(error)
                              })
                      } else {
                          this.loading = false
                      }
                  }
              },
              // 更多凭证
              moreVoucher() {
                  this.$router.push({
                      path: 'voucherManage',
                      query: {
                          companyId: this.$route.query.companyId
                      }
                  })
              },
              // 附件上传返回数据
              addFile(fileList) {
                  this.voucherInfo.attacheds = fileList
              },
              /**
               * 科目组件的回调
               * @param {Object} data 科目的详情数据
               */
              onPicked(data) {
                  console.log('科目组件的回调' ,data);
                  const contentListItem = this.contentList[this.subjectIndexFlag]
                  const { subjectCode, subjectName} = data
                  this.$set(contentListItem, 'subjectCode', subjectCode)
                  this.$set(contentListItem, 'subjectName', subjectName)
                  this.$set(contentListItem, 'showSubject', false)
                  this.showSubjectCom = false
              },
              handleSubjectCom(index) {
                  this.handleSubjectPopover()
                  this.showSubjectCom = true
                  this.subjectIndexFlag = index
              },
              handleAbstractCom(index) {
                  this.handleSubjectPopover()
                  this.selectAbstract = {}
                  this.showAbstractCom = true
                  const {summary, summaryId} = this.contentList[index]
                  this.selectAbstract = {
                      summaryContent: summary,
                      rowId: summaryId
                  }
                  this.subjectIndexFlag = index
              },
              handleCurrency(currencIndex) {
                  let surrencStyle = ''
                  if (+currencIndex === 0) {
                      surrencStyle = 'width:40%'
                  } else if (+currencIndex === 1){
                      surrencStyle = 'width:30%;border-left:1px solid #BBBBBE;border-right:1px solid #BBBBBE;'
                  } else {
                      surrencStyle = 'width:30%'
                  }
                  return surrencStyle
              },
              wtSuccess(){
                  this.$router.back(-1)
              },
              haveToDoFn(todo){
                  if(!todo){
                      this.$router.back(-1)
                  }
              },
              jieDianShenHe(fn,btnType){
                  let url = '/zingbiz/financial/voucher/approvalExecution'
                  let voucherType = 'plain'
                  if (this.$route.query.rowId) {
                      if (this.voucherInfo.voucherType === 'DBD') {
                          voucherType = 'allocation'
                      }
                  }
                  this.executeParams = {
                      postParams:{
                          voucherInfoId : this.$route.query.rowId,
                          voucherStatus: btnType === 'BH' ? 'FQ' : 'YSH',
                          voucherType:voucherType
                      },
                      url: url
                  }
                  if (btnType === 'SH') {
                      this.$refs.workflow[fn](this.executeParams,true)
                  } else if (btnType === 'BH') {
                      this.$refs.workflow[fn](this.executeParams, true)
                  } else {
                      this.$refs.workflow[fn](this.executeParams)
                  }
              },
              // 反审核
              reverseAudit(paramsData) {
                  if (Date.parse(this.voucherInfo.bookkeepingTime) < Date.parse(this.systemSettingData.currentAccountingPeriod + '-01')) {
                      return	this.$message({type :'error', message:'该期间已结账，不能反审核'})
                  }
                  this.hasDeApprove = false
                  if (paramsData && paramsData !== '') {
                      let url = '/zingbiz/financial/voucher/reverseAudit'
  
                      this.$http
                          .get(url, {
                              params: {
                                  rowId: this.$route.query.rowId,
                                  operationNote: paramsData // 反审核原因
                              }
                          })
                          .then(res => {
                              if (res.data.success) {
                                  this.$message({ type: 'success', message: '反审核成功' })
                                  this.voucherInfoById(this.$route.query.rowId)
                                  this.isdisabledNext = true
                                  this.isdisabledPre = true
                              } else {
                                  this.$message({ type: 'error', message: res.data.msg })
                              }
                          })
                          .catch(error => {
                              console.log(error)
                          })
                  }
              },
              handleDeleteAbstractCom() {
                  this.abstractSelect().then(res3 => {
                      this.abstractList = res3.filter(val => {
                          return val.state === 'true'
                      })
                  })
              },
              handleAbstract(params) {
                  console.log('获取到的摘要,', params)
                  const { rowId, summaryContent } = params
                  this.showAbstractCom = false
                  const item = this.contentList[this.subjectIndexFlag]
                  this.$set(item, 'summary', summaryContent)
                  this.$set(item, 'summaryId', rowId)
              },
              // 上传之前
              beforeUpload(file) {
                  this.loading = true
                  console.log('3196----->', this.loading)
              },
              // 图片上传
              uploadSuccess(response, file) {
                  if (file.status) {
                      this.voucherInfo.attacheds.push({
                          fileType: response.data.fileSuffix,
                          fileName: response.data.fileName,
                          path: response.data.relativePath,
                          id: response.data.id,
                          fileSize:response.data.fileSize
                      })
                      this.handlerAttacheds(this.voucherInfo)
                      this.loading = false
                  }
              },
              //查询核算项目
              selectAccountingProject() {
                  let url = '/zingbiz/financial/accountingProject/selectAll'
                  let params = {
                      dataType: 'tree'
                  }
                  this.$http.get(url, { params: params }).then(acct => {
                      this.accountingProjectArray = acct.data.data.tree
                  })
              },
              handlerBusinessCancal(item) {
                  this.$set(item, 'showAccountDetail', false)
              },
              handlerBusinessDetermine(item) {
                  // this.handleSubjectBusinessAccounting()
                  console.log('科目核算确认', this.ruleForm)
                  this.arr = []
                  const {
                      customer: customerRule, customerCode, customerId, customerParentId,
                      department, departmentCode, departmentId, departmentParentId,
                      materiel, materielCode, materielId, materielParentId,
                      staffMember, staffMemberCode, staffMemberId, staffMemberParentId,
                      supplier: supplierRule, supplierCode, supplierId, supplierParentId,
                      warehouse, warehouseCode, warehouseId, warehouseParentId,
                      showCustomer, showSupplier, showWarehouse, showMateriel, showDepartment, showStaffMember
                  } = this.ruleForm
                  if (!zIsempty20(customerRule) && showCustomer) {
                      this.handleSubjectBusinessAccountingDetail(customerCode, customerRule, customerParentId, customerId)
                  }
                  if (!zIsempty20(supplierRule) && showSupplier) {
                      this.handleSubjectBusinessAccountingDetail(supplierCode, supplierRule, supplierParentId, supplierId)
                  }
                  if (!zIsempty20(warehouse) && showWarehouse) {
                      this.handleSubjectBusinessAccountingDetail(warehouseCode, warehouse, warehouseParentId, warehouseId)
                  }
                  if (!zIsempty20(materiel) && showMateriel) {
                      this.handleSubjectBusinessAccountingDetail(materielCode, materiel, materielParentId, materielId)
                  }
                  if (!zIsempty20(department) && showDepartment) {
                      this.handleSubjectBusinessAccountingDetail(departmentCode, department, departmentParentId, departmentId)
                  }
                  if (!zIsempty20(staffMember) && showStaffMember) {
                      this.handleSubjectBusinessAccountingDetail(staffMemberCode, staffMember, staffMemberParentId, staffMemberId)
                  }
                  console.log(this.arr, '32323232------->>>')
                  this.item.accountingProject = this.arr.join(' ')
                  this.$set(item, 'showAccountDetail', false)
              },
              handleSubjectBusinessAccountingDetail(code, name, parentId, id) {
                  if (code) {
                      this.item.fullData += '.' + code + '_' + name
                  } else {
                      this.item.fullData += '.' + name
                  }
                  let str = parentId + '#' + id
                  this.arr.push(str)
              },
              // 点击凭证录入的表格，让 科目中的 el-popover 隐藏
              handleSubjectPopover() {
                  // console.log('---点击凭证录入的表格-el-popover 隐藏--', this.item)
                  this.handleHidePopover()
              },
              // 科目中的 el-popover 显示，点击表格以外的区域提示
              handleLeaveTip() {
                  if (this.ruleForm && !zIsempty20(this.item.showAccountDetail)) {
                      const {customer: customerRule, department, materiel, staffMember, supplier: supplierRule, warehouse,
                          showCustomer, showSupplier, showWarehouse, showMateriel, showDepartment, showStaffMember} = this.ruleForm
                      if (zIsempty20(customerRule) && showCustomer) {
                          return this.$message({ type:'error', message: '客户为必录项，不允许为空'})
                      }
                      if (zIsempty20(supplierRule) && showSupplier) {
                          return this.$message({ type:'error', message: '供应商为必录项，不允许为空'})
                      }
                      if (zIsempty20(warehouse) && showWarehouse) {
                          return this.$message({ type:'error', message: '仓库为必录项，不允许为空'})
                      }
                      if (zIsempty20(materiel) && showMateriel) {
                          return this.$message({ type:'error', message: '物料为必录项，不允许为空'})
                      }
                      if (zIsempty20(department) && showDepartment) {
                          return this.$message({ type:'error', message: '部门为必录项，不允许为空'})
                      }
                      if (zIsempty20(staffMember) && showStaffMember) {
                          return this.$message({ type:'error', message: '职员为必录项，不允许为空'})
                      }
                      return this.$set(this.item, 'showAccountDetail', false)
                  }
                  if (!zIsempty20(this.nextFn)) {
                      this.nextFn()
                  }
              },
              // 凭证录入页面点击事件，配合选科目时弹出 el-popover 组件
              handleAddVoucher() {
                  this.handleLeaveTip()
              },
              // 客户
              confirmCustomer(val) {
                  console.log('客户', val)
                  console.log(this.supplierListobj, '3162----->>')
  
                  const {contactsName, code, supplierMainName} = val
                  this.$set(this.ruleForm, 'customer', contactsName ? contactsName : supplierMainName)
                  this.$set(this.ruleForm, 'customerCode', code)
                  this.handleSupplierList('客户', contactsName ? contactsName : supplierMainName, code)
                  this.customerVisible = false
              },
              // 处理科目下的辅助核算相对应的 id 以及 parentId
              handleSupplierList(businessAccountingName, name, code, id) {
                  if (this.supplierListobj && Object.keys(this.supplierListobj).length > 0) {
                      Object.keys(this.supplierListobj).forEach( item => {
                          if (item === businessAccountingName) {
                              for(let i = 0; i < this.supplierListobj[businessAccountingName].length; i ++) {
                                  const ele = this.supplierListobj[businessAccountingName][i]
                                  if (ele.name === name && ele.code === code && businessAccountingName === '客户') {
                                      this.$set(this.ruleForm, 'customerId', ele.id)
                                      this.$set(this.ruleForm, 'customerParentId', ele.parentId)
                                      console.log('客户-获取id/parentId', this.ruleForm)
                                      break
                                  }
                                  if (ele.name === name && ele.code === code && businessAccountingName === '供应商') {
                                      this.$set(this.ruleForm, 'supplierId', ele.id)
                                      this.$set(this.ruleForm, 'supplierParentId', ele.parentId)
                                      console.log('供应商-获取id/parentId', this.ruleForm)
                                      break
                                  }
                                  if (ele.name === name && ele.code === code && businessAccountingName === '仓库') {
                                      this.$set(this.ruleForm, 'warehouseId', ele.id)
                                      this.$set(this.ruleForm, 'warehouseParentId', ele.parentId)
                                      console.log('仓库-获取id/parentId', this.ruleForm)
                                      break
                                  }
                                  if (ele.name === name && ele.code === code && businessAccountingName === '物料') {
                                      this.$set(this.ruleForm, 'materielId', ele.id)
                                      this.$set(this.ruleForm, 'materielParentId', ele.parentId)
                                      console.log('物料-获取id/parentId', this.ruleForm)
                                      break
                                  }
                                  if (ele.name === name && ele.originalId === id && businessAccountingName === '部门') {
                                      this.$set(this.ruleForm, 'departmentId', ele.id)
                                      this.$set(this.ruleForm, 'departmentCode', ele.code)
                                      this.$set(this.ruleForm, 'departmentParentId', ele.parentId)
                                      console.log('部门-获取id/parentId', this.ruleForm)
                                      break
                                  }
                                  if (ele.name === name && businessAccountingName === '职员') {
                                      this.$set(this.ruleForm, 'staffMemberId', ele.id)
                                      this.$set(this.ruleForm, 'staffMemberCode', ele.code)
                                      this.$set(this.ruleForm, 'staffMemberParentId', ele.parentId)
                                      console.log('职员-获取id/parentId', this.ruleForm)
                                      break
                                  }
                              }
                          }
                      })
                  }
              },
              // 供应商
              confirmSupplier(val) {
                  console.log('供应商', val)
                  this.ruleForm.supplier = val.supplierMainName
                  this.ruleForm.supplierCode = val.code
                  this.searchData.supplierMainName = val.supplierMainName
                  this.handleSupplierList('供应商', val.supplierMainName, val.code)
                  this.supplierVisible = false
              },
              // 仓库
              handlerWarehouse(val) {
                  console.log('仓库', val)
                  const { goodsStorehouseCode: code, goodsStorehouseName: name} = val
                  this.ruleForm.warehouse = name
                  this.ruleForm.warehouseCode = code
                  this.handleSupplierList('仓库', name, code)
              },
              // 选择 入库仓库
              getWarehouseList(val) {
                  this.orderInfo.storehouseName = val.goodsStorehouseName
                  this.orderInfo.storehouseId = val.rowId
                  this.$refs.storehouseNameRef.blur()
                  this.getCardUrlList(val.rowId)
              },
              validateWarehouse() {
                  // this.$refs.ruleFormIn.validateField('storehouseName')
              },
              addVoucherGoodList() {
                  let url = '/zingbiz/goodsStorehouse/productRest/searchSpecifications'
                  let params = {
                      disable: 'false'
                  }
                  let requestMethod = 'post'
                  //物品去重和勾选回显
                  // this.filterIds = []
                  // this.batchInfoItems.map(item =>{
                  //     this.filterIds.push(item.partNumber)
                  // })
                  this.$refs.goodsListRef.show(params,url,requestMethod)
              },
              // 物料--物品信息
              handlerMateriel(val) {
                  console.log('物品信息', val);
                  if (val && val.length > 0) {
                      const { productName, partNumber} = val[0]
                      this.ruleForm.materiel = productName
                      this.ruleForm.materielCode = partNumber
                      this.handleSupplierList('物料', productName, partNumber)
                  }
              },
              // 职员 = 选人
              handleDeptMemberonConfirm(checkDeptList) {
                  console.log('职员 = 选人', checkDeptList)
                  this.formData = checkDeptList
                  const name = checkDeptList[0].userName
                  this.ruleForm.staffMember = name
                  this.handleSupplierList('职员', name)
                  this.showDeptMemberVisible = false
              },
              // 部门
              handlerDepartment(val) {
                  console.log(val, '--部门-val')
                  this.ruleForm.department = val[0].text
                  this.initialSelectedDept = val
                  this.handleSupplierList('部门', val[0].text, '', val[0].id)
                  this.showPersonPicker = false
              },
              // 职员
              handlerStaffMember() {
  
              },
              /**
               * 请求 科目 中的辅助核算
               * @param {String} id 客户/供应商/仓库/物料/部门/职员
               */
              handleAccountingProject(id, resolve) {
                  let url = '/zingbiz/financial/accountingProject/selectAll'
                  this.$http.get(url,{
                      params:{
                          id:id,
                          pageNumber:1,
                          pageSize:9999
                      }
                  }).then(res => {
                      if (res.data.success) {
                          let name = res.data.data.tree[0].name
                          let obj = {
                              [name]: res.data.data.table
                          }
                          this.supplierListobj = Object.assign(this.supplierListobj, obj);
                          if (name === '客户') {
                              this.ruleForm.showCustomer = true
                          } else if (name === '供应商') {
                              this.ruleForm.showSupplier = true
                          } else if (name === '仓库' ) {
                              this.ruleForm.showWarehouse = true
                          } else if (name === '物料' ) {
                              this.ruleForm.showMateriel = true
                          } else if (name === '部门' ) {
                              this.ruleForm.showDepartment = true
                          } else if (name === '职员' ) {
                              this.ruleForm.showStaffMember = true
                          }
                          resolve()
                      } else {
                          this.$message({ type: 'error', message: res.data.msg })
                      }
                  }).catch(error => {
                      console.log(error)
                  })
              },
              // 附件 添加
              AddannexList(data) {
                  this.voucherInfo.attacheds.push(this.handleImgParameter(data))
              },
              // 附件 删除
              deleteAnnex(item) {
                  this.voucherInfo.attacheds = this.voucherInfo.attacheds.filter(el => el.id !== item.id)
              },
              handleImgParameter(resData) {
                  return {
                      fileType: resData.fileType,
                      fileName: resData.fileName,
                      path: resData.relativePath,
                      id: resData.id,
                      fileSize:resData.fileSize,
                      creater: resData.creater,
                      relativePath: resData.relativePath,
                      fileSizeStr: resData.fileSizeStr,
                      fileSuffix: resData.fileSuffix,
                      genTime: resData.genTime,
                      iconClass: this.selectFileType(resData)
                  }
              },
              selectFileType(val) {
                  let type = ''
  
                  if (val.fileType === 'jpg' || val.fileType === 'jpeg' || val.fileType === 'png' || val.fileType === 'gif' || val.fileType === 'image') {
                      type = 'image'
                      // item.path = getThumbUrl(item.relativePath,26,26,'./static/images/ysImg.png',false)
                  } else if (val.fileType === 'xls' || val.fileType === 'xlsx') {
                      type = '#icon-ECEL'
                  } else if (val.fileType === 'doc' || val.fileType === 'docx') {
                      type = '#icon-WORD'
                  } else if (val.fileType === 'ppt' || val.fileType === 'pptx') {
                      type = '#icon-PPT'
                  } else if (val.fileType === 'pdf') {
                      type = '#icon-PDF'
                  } else if (val.fileType === 'properties' || val.fileType === 'log' || val === 'txt') {
                      type = '#icon-TET'
                  } else if (val.fileType === 'zip' || val.fileType === 'rar') {
                      type = '#icon-ZIP'
                  } else {
                      type = '#icon-GIF1'
                  }
                  return type
              },
              // 智能凭证编辑后 保存修改后数据
              pickData() {
                  this.voucherInfo.voucherInfoItems = this.contentList
                  let param = deepCopy(this.voucherInfo)
                  param.debitCount = 0
                  param.lenderCount = 0
                  let params = handlerTmepData(param,true, this)
                  if (params) {
                      this.$http.post('/zingbiz/financial/todoVoucherInfoRest/update', params).then(res => {
                          if (res.data.success) {
                              this.$message({ type:'success', message:'保存成功'})
                              this.$router.back(-1)
                          } else {
                              this.$message({ type:'error', message:res.data.msg})
                          }
                      })
                  }
              },
              // 处理摘要样式
              handleAbstractStyle(index) {
                  if (this.indexFlag === index && this.showAbstractName) {
                      return 'abstract-input-none'
                  }
                  if (index === this.indexFlag) {
                      return 'abstract-input'
                  }
                  return ''
              },
              // 处理科目样式
              handleSubjectStyle(index) {
                  if (+this.indexFlag === +index && this.showSubjectName) {
                      return 'subject-input-none'
                  }
                  if (+index === +this.indexFlag) {
                      return 'subject-input'
                  }
                  return ''
              },
              handleTdStyle(index) {
                  if (index === this.indexFlag) {
                      return 'background-color:#F5F7FA;'
                  }
                  return ''
              },
              handleQuantityStyle(index) {
                  if (this.showNumberIndex && (index === this.indexFlag)) {
                      return 'background-color:#fff;'
                  }
                  return ''
              },
              handleUnitPriceStyle(index) {
                  if (this.showUnitPriceIndex && (index === this.indexFlag)) {
                      return 'background-color:#fff;'
                  }
                  return ''
              },
              handleOriginCurrency(index) {
                  if (this.showOriginalCurrencyIndex && (index === this.indexFlag)) {
                      return 'background-color:#fff;'
                  }
                  if (index === this.indexFlag) {
                      return 'background-color:#F5F7FA;'
                  }
                  return ''
              },
              handleCurrencytClass(index) {
                  if (+this.indexFlag === +index && this.showCurrencytIndex) {
                      return 'set-select-input-none'
                  }
                  if (+index === +this.indexFlag) {
                      return 'set-select-input'
                  }
                  return ''
              },
              handleLoanStyle(index) {
                  if (+this.indexFlag === +index && this.showLoanIndex) {
                      return 'background-color:#fff;'
                  }
                  if (+index === +this.indexFlag) {
                      return 'background-color:#F5F7FA;'
                  }
                  return ''
              },
              handleBorrowStyle(index) {
                  if (+this.indexFlag === +index && this.showBorrowIndex) {
                      return 'background-color:#fff;'
                  }
                  if (+index === +this.indexFlag) {
                      return 'background-color:#F5F7FA;'
                  }
                  return ''
              },
              handleShowTask() {
                  this.showAddTask = true
                  if (this.voucherInfo.relationCard && this.voucherInfo.relationCard.length === 0) {
                      this.voucherInfo.relationCard.push(deepCopy(this.relationCardItem))
                  } else if (this.voucherInfo.relationCard === undefined || this.voucherInfo.relationCard === null){
                      this.voucherInfo.relationCard = [deepCopy(this.relationCardItem)]
                  }
              },
              handleSubjectTopTip(item) {
                  const {subjectCode, subjectName, fullData} = item
                  let str = ''
                  if (!zIsempty20(subjectCode)) {
                      str += subjectCode + ' '
                  }
                  if (!zIsempty20(subjectName)) {
                      str += subjectName + ' '
                  }
                  if (!zIsempty20(fullData)) {
                      str += fullData + ' '
                  }
                  this.$nextTick(() => {
                      let divContent = str
                      if (this.divWidth === 0) {
                          this.divWidth = this.$refs.subjectContent[0].clientWidth
                      }
                      let spanWidth = 0
                      let span = document.createElement('span')
                      span.setAttribute('id', 'span')
                      document.body.appendChild(span)
                      document.querySelector('#span').innerHTML = divContent
                      spanWidth = span.offsetWidth
                      document.body.removeChild(span)
                      if (spanWidth > this.divWidth) {
                          this.$set(item, 'lineClamp2', true)
                      } else {
                          this.$set(item, 'lineClamp2', false)
                      }
                  })
                  return str
              },
              handleSetUnitName(params) {
                  let name = ''
                  if (zIsempty20(params.unit)) {
                      return name
                  }
                  if (this.measureList && this.measureList.length > 0) {
                      const zIndex = this.measureList.findIndex( item => item.rowId === params.unit)
                      if (zIndex !== -1) {
                          name = this.measureList[zIndex].val
                      }
                  }
                  return name
              }
              // handleSummanryName(id) {
              // 	let arr = this.abstractList.filter(val => {
              // 		return val.rowId === id
              // 	})
              // 	if (arr.length !== 0) {
              // 		return arr[0].summaryContent
              // 	}
              // }
          }
      }
  </script>
  
  <style lang="stylus" rel="stylesheet/stylus">
    #addVoucher{
      .readonlySelect_special{
        .el-input__inner {
          background-color: white
          color: #000
          border: none
          border-bottom: 1px solid #BBBBBB
          border-radius: 0
        }
      }
      .set-select{
        // background:red;
        border none
        direction none
      }
      .set-select > .el-input{
        border none
        direction none
  
        input{
          border none
          height: 53px;
          line-height: 53px;
          border-radius: 0;
        }
      }
      .set-select-input-none > .el-input{
        input{
          background-color: #fff;
        }
      }
      .set-select-input > .el-input{
        input {
          background-color: #F5F7FA;
        }
      }
      .set-select:focus{
        outline none
      }
      tr, td{
        height:53px;
      }
      .el-main{
        overflow auto
        padding 0
        // background #f0f2f5
      }
    }
    // #add-voucher-subjcet, #add-voucher-abstract{
    // .el-select-dropdown__item:hover:first-child{
    // 	background:red;
    // 	display:none;
    // }
    // .el-select-dropdown__item:first-child{
    // 	background:red;
    // 	display:none;
    // }
    // }
    .add-voucher-title{
      height: 60px;
      line-height: 60px;
      padding-left: 20px;
      background: #fff;
      font-size: 18px;
      font-weight: 400;
    }
    // #add-voucher-popover{
    #add-voucher-popover-content{
      width: 300px;
      min-height: 100px;
  
      .add-voucher-popover-content-show{
        display: flex;
        align-items: center;
        margin-bottom: 15px;
  
        &-label{
          display: inline-block;
          width: 75px;
          text-align: right;
          padding-right: 8px;
  
          span{
            color: red;
          }
        }
        &-input{
          border-bottom: 1px solid #BBBBBB;
  
          input{
            border: none;
          }
  
          i{
            display: inline-block;
            height: 32px;
            line-height: 32px;
            cursor: pointer;
          }
        }
      }
    }
    // }
  
  </style>
  <style lang="stylus" rel="stylesheet/stylus" scoped>
    body .addVoucher .addVoucher-content .readonlySelect_special >>> .el-input__inner {
      background-color: white !important
      color: #000  !important
      padding-right: 0;
    }
  
    body .addVoucher .addVoucher-content .resetBorder >>> .el-input__inner{
      border:0 !important
      outline: none !important
      padding-right: 0;
      //   background-color: #F5F7FA;
      height: 53px;
    }
    .isdisabledPre,.isdisabledNext{
      color: #40AAFA
    }
    .yishenhe{
      position: absolute;
      font-size: 80px;
      color: red;
          right: 0;
      z-index: 10;
    }
    .addVoucher .addVoucher-content .resetBorder{
      width:100%
      height: 50px;
      line-height: 50px;
    }
    .addVoucher{
      height: 100%;
      min-width: 1350px;
      background-color: #f0f2f5;
      //   min-width 1070px
      //   overflow auto
      &-header{
        height: 42px;
        line-height: 31px;
        width 100%
        text-align center
        &-title{
          color: rgba(16, 16, 16, 1);
          font-size: 20px;
          font-family: SourceHanSansSC-regular;
        }
        &-right{
          float right
          font-size: 14px;
          text-align: center;
          font-family: Microsoft Yahei;
        }
      }
      &-content{
        width 100%
        background-color white
        padding 10px 30px 30px
        &-top,&-bottom{
          margin-left 21px
        }
        .plusOrMinus,.isLenderMinus,.isDebitMinus{
          color red
        }
        table{
          width 100%
          table-layout:fixed
          border-collapse: collapse
        }
        table .number{
          width: 80px;
          text-align: center;
        }
        table .operate{
          width: 20px;
          text-align: center;
          border:0px
        }
        table td{
          background-color: #FFFFFF
        }
        table th,table td{
          box-sizing: content-box
          border: 1px solid #BBBBBE
          width: 297px
          height: 50px
        }
        .quantity,.currency{
          min-width:150px
          &-content{
            display:flex;
  
            &-currency-type{
              height: 53px;
              width: 40%;
              display: flex;
            }
  
            &-exchange-rate{
              border-left: 1px solid #BBBBBE;
              border-right: 1px solid #BBBBBE;
              width: 30%;
              line-height: 52px;
            }
  
            &-original-currency{
              width: 30%;
              display: flex;
              line-height: 52px;
            }
  
            &-company{
              text-align: center;
            }
          }
        }
        tbody tr,thead tr{
          .subject {
            width: calc(100% - 620px);
            &-input-none >>> .el-input__inner{
              background-color: #fff;
            }
            &-input >>> .el-input__inner{
              background-color: #F5F7FA;
            }
            &-input-none{
              background-color: #fff;
            }
            &-input{
              background-color: #F5F7FA;
            }
            .content-value{
              position relative
              height 100%
              width 100%
              background: #fff;
  
              .describe{
                height 100%
                width 100%
                padding-left 10px
                // div{
                //   position relative
                //   top: 50%
                //   transform: translateY(-50%);
                // }
              }
            }
          }
          .abstract{
            width: 517px
            &-input-none >>> .el-input__inner{
              background-color: #fff;
            }
            &-input >>> .el-input__inner{
              background-color: #F5F7FA;
            }
          }
        }
        table th{
          text-align: center
        }
        .voucher-direction{
          display: block;
          height: 25px;
          line-height: 25px
        }
        .voucher-money{
          height: 25px;
          font-size: 12px;
          font-weight: normal;
          border-top: 1px solid #dadada;
          text-align: center;
          background: url("http://source.qmenhu.com/data/source/imgs/zing/money_rp.png") no-repeat;
          line-height: 25px;
          background-color: white;
          background-size: 297px 25px;
        }
        .voucher-money span{
          float: left;
          display: inline;
          width: 26px;
          height: 100%;
          margin-right: 1px;
        }
        .voucher-money .last{
          border: none;
        }
        .borrow-money,.credit-money{
          background: url("http://source.qmenhu.com/data/source/imgs/zing/money_rp.png") no-repeat;
          background-color: white;
          background-size: 297px 50px;
          line-height: 50px
          height: 50px
        }
        .borrow-money .content-value,.credit-money .content-value{
          padding 0
          font-family: 'tahoma';
          /*font-weight: bold;*/
          font-size: 13px;
          letter-spacing: 19px;
          overflow: hidden;
          position: relative;
        }
        .content-value{
          //   padding: 0 5px;
          font-size: 14px;
          word-break: break-all;
          word-wrap: break-word
        }
        .quantity,.currency,.addVoucher-content-top{
          input{
            width 60%
            -webkit-appearance: none;
            -moz-appearance: none;
            -o-appearance: none;
            appearance: none;
            background:none;
            outline:none;
            border:none;
            border-bottom:1px solid #ccc
          }
          .exchangeRate{
            width calc(60% - 26px)
          }
          input:focus{
            /*border:none;*/
          }
          .addVoucher-bookkeeping-voucher{
            text-align: center;
            line-height: 30px;
            font-size: 20px;
            color: #101010;
            letter-spacing: 10px;
          }
          .addVoucher-bookkeeping-voucher-title-content{
            display:flex;
            justify-content:space-between;
            align-items:center;
          }
  
          &-enclosure{
            height: 32px;
            line-height: 32px;
            text-align: right
          }
  
          &-enclosure-Number{
            border-bottom:1px solid #101010;
            height: 32px;
            display: inline-block;
            text-align: center;
            width:30px;
          }
        }
        .inputMoney{
          -webkit-appearance: none;
          -moz-appearance: none;
          -o-appearance: none;
          appearance: none;
          background:none;
          outline:none;
          border:none;
          width 100%
          height 100%
          line-height 50px
          padding-right 0
        }
        .inputMoney:focus{
          width 100%
          height 50px
          line-height 50px
          border:none;
        }
        &-table-icon{
          width 18px
          height 18px
          border-radius 9px
          background-color #ff8000
          color white
          cursor:pointer
          line-height:16px;
          display:inline-block;
  
          &-add{
            text-align:center;
          }
          &-reduce{
            margin-left:10px;
          }
        }
        &-table-icon:first-child{
          margin-bottom 2px
          line-height: 18px;
        }
      }
      .relation-card-table{
        width:100%;
  
        tbody{
          tr:first-child{
            td{
              border-top:0;
            }
          }
        }
      }
      .relation-card{
        width:80px;
        display:table-cell;
        vertical-align:middle;
        text-align: center;
        position:relative;
        border-right: 2px solid #BBBBBE;
  
        &-icon{
          display: flex;
          align-items: center;
          justify-content: center;
        }
      }
      .icon-add{
        width 18px
        height 18px
        border-radius 9px
        background-color #ff8000
        color white
        cursor:pointer
        line-height: 15px
      }
      .icon-minus{
        margin-left:5px;
      }
    }
  
  
    .initInput{
      background:none;
      border none
      outline none
      height: 50px
      width 100%
      white-space:normal;
      word-wrap:break-word;
      word-break:break-all
    }
    .initInput:focus{
      border none
    }
    .summaryStyle{
      background-color #fff
      width 90%
      position: absolute
      bottom: 0
      left: 5%
      z-index: 9
      transform translateY(110%)
      max-height 102px
      overflow-y auto
      border: 1px solid #e4e7ed
      li{
        color: #606266;
        font-size 14px
        cursor: pointer
        width 100%
        padding 0 5px
        height 34px
        line-height 34px
        padding 0 20px
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis
        &:hover{
          background-color #f5f7fa
        }
      }
      &:before{
        content: "";
        display block
        height 0
        width 0
        position:absolute;
        z-index 10
        left:5px;
        top:-10px;
        border-bottom: solid 10px #f5f5f5;
        border-left: solid 10px transparent;
        border-right: solid 10px transparent;
      }
    }
    .dot{
      overflow hidden
      text-overflow ellipsis
      white-space nowrap
    }
    .subject-static-style{
      height: 53px;
      cursor:pointer;
      // overflow: auto;
      overflow: hidden;
      padding:0 50px 0 10px;
      line-height: 53px;
      position:relative;
  
          .subject-item-lineClamp2{
              text-overflow: -o-ellipsis-lastline;
              overflow: hidden;
              text-overflow: ellipsis;
              line-height: 30px;
              display: -webkit-box;
              -webkit-line-clamp: 2;
              line-clamp: 2;
              -webkit-box-orient: vertical;
          }
  
      &-balance{
        position: absolute;
        bottom: -18px;
        right: 60px;
      }
    }
  </style>
  